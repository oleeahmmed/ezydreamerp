{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
<style>
/* Use default theme variables */
.loader { 
    border: 3px solid hsl(var(--muted)); 
    border-top: 3px solid hsl(var(--primary)); 
    border-radius: 50%; 
    width: 20px; 
    height: 20px; 
    animation: spin 1s linear infinite; 
    display: inline-block;
}

@keyframes spin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
}

/* Filter dropdown styles */
.filter-dropdown {
    background: hsl(var(--popover));
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.filter-option {
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.filter-option:hover {
    background: hsl(var(--accent));
}

.filter-option.active {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
}

/* Copy button styles */
.copy-btn {
    background: hsl(var(--secondary));
    color: hsl(var(--secondary-foreground));
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover {
    background: hsl(var(--accent));
    color: hsl(var(--accent-foreground));
}

.copy-btn.copied {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
}

/* Status filter badges */
.status-filter-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid hsl(var(--border));
}

.status-filter-badge:hover {
    background: hsl(var(--accent));
}

.status-filter-badge.active {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
}

.status-filter-badge.present {
    background: hsl(142 76% 36%);
    color: white;
}

.status-filter-badge.absent {
    background: hsl(0 84% 60%);
    color: white;
}

.status-filter-badge.late {
    background: hsl(45 93% 47%);
    color: white;
}

.status-filter-badge.leave {
    background: hsl(217 91% 60%);
    color: white;
}

.status-filter-badge.holiday {
    background: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
}

.status-filter-badge.half-day {
    background: hsl(25 95% 53%);
    color: white;
}

/* Toast notification */
.toast {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 50;
    padding: 1rem;
    border-radius: var(--radius);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    max-width: 24rem;
    transition: all 0.3s;
    transform: translateX(100%);
}

.toast.show {
    transform: translateX(0);
}

.toast.success {
    background: hsl(142 76% 36%);
    color: white;
}

.toast.error {
    background: hsl(var(--destructive));
    color: hsl(var(--destructive-foreground));
}

.toast.warning {
    background: hsl(45 93% 47%);
    color: white;
}

.toast.info {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
}

/* Print styles */
@media print {
    .no-print { display: none !important; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; font-weight: bold; }
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white dark:bg-gray-900 rounded-xl border-2 border-gray-200 dark:border-gray-700 shadow-lg p-4 sm:p-8 mb-6">
        <!-- Header -->
        <div class="mb-6 sm:mb-8 border-b border-gray-200 dark:border-gray-700 pb-4 sm:pb-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-xl bg-blue-600 text-white shadow-md">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{{ title }}</h1>
                        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">{{ subtitle }}</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="generate-report-btn" class="inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 px-6 py-3 shadow-md">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 17h6l3 3v-3h2V5H4v12h5zm-2 0H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v9a2 2 0 01-2 2h-1l-3 3-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Generate Report
                    </button>
                    
                    {% if data_generated %}
                    <button id="print-table-btn" class="no-print inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-gray-600 text-white hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 px-6 py-3 shadow-md">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Print PDF
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% include "common/toast.html" %}

        <!-- Results Section -->
        {% if data_generated %}
        <div class="mb-6">
            <!-- Summary Stats -->
            <div class="bg-blue-600 text-white p-4 rounded-lg mb-4">
                <h4 class="text-lg font-bold mb-2">📊 Report Summary</h4>
                <div class="grid grid-cols-2 md:grid-cols-8 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold">{{ summary_stats.total_records }}</div>
                        <div class="opacity-90">Total Records</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-300">{{ summary_stats.present_records }}</div>
                        <div class="opacity-90">Present</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-300">{{ summary_stats.absent_records }}</div>
                        <div class="opacity-90">Absent</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-300">{{ summary_stats.late_records }}</div>
                        <div class="opacity-90">Late</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">{{ summary_stats.leave_records }}</div>
                        <div class="opacity-90">Leave</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">{{ summary_stats.holiday_records }}</div>
                        <div class="opacity-90">Holiday</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-300">{{ summary_stats.new_records }}</div>
                        <div class="opacity-90">New</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-300">{{ summary_stats.existing_records }}</div>
                        <div class="opacity-90">Existing</div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4 no-print">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                    <!-- Status Filters -->
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Filter by Status:</span>
                        <button class="status-filter-badge active" data-status="all">
                            All <span class="ml-1 text-xs" id="count-all">{{ summary_stats.total_records }}</span>
                        </button>
                        <button class="status-filter-badge present" data-status="PRE">
                            Present <span class="ml-1 text-xs" id="count-present">{{ summary_stats.present_records }}</span>
                        </button>
                        <button class="status-filter-badge absent" data-status="ABS">
                            Absent <span class="ml-1 text-xs" id="count-absent">{{ summary_stats.absent_records }}</span>
                        </button>
                        <button class="status-filter-badge late" data-status="LAT">
                            Late <span class="ml-1 text-xs" id="count-late">{{ summary_stats.late_records }}</span>
                        </button>
                        <button class="status-filter-badge leave" data-status="LEA">
                            Leave <span class="ml-1 text-xs" id="count-leave">{{ summary_stats.leave_records }}</span>
                        </button>
                        <button class="status-filter-badge holiday" data-status="HOL">
                            Holiday <span class="ml-1 text-xs" id="count-holiday">{{ summary_stats.holiday_records }}</span>
                        </button>
                        <button class="status-filter-badge half-day" data-status="HAL">
                            Half Day <span class="ml-1 text-xs" id="count-half-day">{{ summary_stats.half_day_records }}</span>
                        </button>
                    </div>
                    
                    <!-- Search and Additional Filters -->
                    <div class="flex items-center gap-3">
                        <!-- Search Input -->
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="Search employee..." 
                                   class="w-64 px-3 py-2 pl-10 text-sm border border-gray-300 dark:border-gray-600 rounded-md 
                                          focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
                                          dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
                            <svg class="absolute left-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- Date Filter -->
                        <select id="date-filter" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md 
                                               focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
                                               dark:bg-gray-700 dark:text-white">
                            <option value="all">All Dates</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="this-week">This Week</option>
                            <option value="last-week">Last Week</option>
                        </select>
                        
                        <!-- Copy Options -->
                        <div class="relative">
                            <button id="copy-dropdown-btn" class="inline-flex items-center gap-2 px-3 py-2 text-sm 
                                                          bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 
                                                          text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 
                                                          transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy Data
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div id="copy-dropdown" class="absolute right-0 mt-2 w-48 filter-dropdown hidden z-10">
                                <button class="filter-option w-full text-left" data-copy="selected">Copy Selected Records</button>
                                <button class="filter-option w-full text-left" data-copy="visible">Copy Visible Records</button>
                                <button class="filter-option w-full text-left" data-copy="all">Copy All Records</button>
                                <button class="filter-option w-full text-left" data-copy="summary">Copy Summary</button>
                                <button class="filter-option w-full text-left" data-copy="employee-ids">Copy Employee IDs</button>
                            </div>
                        </div>
                        
                        <!-- Clear Filters -->
                        <button id="clear-filters-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 
                                                       text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 
                                                       transition-colors">
                            Clear Filters
                        </button>
                    </div>
                </div>
                
                <!-- Active Filters Display -->
                <div id="active-filters" class="mt-3 flex flex-wrap items-center gap-2 hidden">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Active filters:</span>
                    <div id="active-filters-list" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4 no-print">
                <div class="flex flex-wrap items-center gap-4">
                    <!-- Selection Controls -->
                    <div class="flex items-center gap-2">
                        <button id="select-all-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 transition-colors">
                            Select All
                        </button>
                        <button id="select-none-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 transition-colors">
                            Select None
                        </button>
                        <button id="select-new-btn" class="px-3 py-2 text-sm bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 rounded-md border border-blue-300 dark:border-blue-600 transition-colors">
                            Select New
                        </button>
                    </div>
                    
                    <!-- Selection Info -->
                    <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span id="selection-count">0</span> records selected
                    </div>
                    
                    <!-- Import Buttons -->
                    <div class="flex items-center gap-2">
                        <button id="import-selected-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-md transition-colors" disabled>
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import Selected
                        </button>
                        <button id="import-all-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-orange-600 hover:bg-orange-700 text-white rounded-md transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import All
                        </button>
                        <button id="import-new-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import New Only
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700" id="attendance-table">
                <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                    <table class="w-full border-collapse min-w-max">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 no-print">
                                    <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">EMPLOYEE ID</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">EMPLOYEE NAME</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">DATE</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">STATUS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">CHECK IN</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">CHECK OUT</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">WORKING HOURS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">LATE MINUTES</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">OVERTIME</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">SHIFT</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">IMPORT STATUS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">REMARKS</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-tbody">
                            {% for record in attendance_records %}
                            <tr class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors attendance-row" 
                                data-employee-id="{{ record.employee_id }}"
                                data-date="{{ record.date }}"
                                data-status="{{ record.status }}"
                                data-is-duplicate="{{ record.is_duplicate|yesno:'true,false' }}"
                                data-selected="{{ record.selected|yesno:'true,false' }}"
                                data-working-hours="{{ record.working_hours|default:0 }}"
                                data-late-minutes="{{ record.late_minutes|default:0 }}"
                                data-overtime-minutes="{{ record.overtime_minutes|default:0 }}">
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 no-print">
                                    <input type="checkbox" class="row-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                           {% if record.selected %}checked{% endif %}
                                           data-record-index="{{ forloop.counter0 }}">
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 font-medium text-gray-900 dark:text-gray-100">{{ record.employee_id }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.employee_name }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.date }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.status == 'PRE' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Present</span>
                                    {% elif record.status == 'ABS' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Absent</span>
                                    {% elif record.status == 'LAT' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Late</span>
                                    {% elif record.status == 'LEA' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Leave</span>
                                    {% elif record.status == 'HOL' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Holiday</span>
                                    {% elif record.status == 'HAL' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">Half Day</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">
                                    {% if record.check_in %}{{ record.check_in|slice:":16" }}{% else %}--:--{% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">
                                    {% if record.check_out %}{{ record.check_out|slice:":16" }}{% else %}--:--{% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-blue-600 dark:text-blue-400">{{ record.working_hours|floatformat:1 }}h</span>
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.late_minutes > 0 %}
                                        <span class="font-bold text-red-600 dark:text-red-400">{{ record.late_minutes }}m</span>
                                    {% else %}
                                        <span class="text-gray-500 dark:text-gray-400">0m</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.overtime_minutes > 0 %}
                                        <span class="font-bold text-green-600 dark:text-green-400">{{ record.overtime_minutes }}m</span>
                                    {% else %}
                                        <span class="text-gray-500 dark:text-gray-400">0m</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.shift_name }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.is_duplicate %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Imported</span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">New</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">
                                    {% if record.remarks %}
                                        <span class="text-gray-600 dark:text-gray-400">{{ record.remarks|truncatechars:50 }}</span>
                                    {% else %}
                                        <span class="text-gray-500 dark:text-gray-500">--</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="13" class="px-4 py-8 text-center text-sm border border-gray-200 dark:border-gray-600">
                                    <div class="flex flex-col items-center justify-center space-y-4">
                                        <div class="rounded-full bg-gray-100 dark:bg-gray-700 p-4">
                                            <svg class="h-8 w-8 text-gray-400 dark:text-gray-500" viewBox="0 0 24 24" fill="none">
                                                <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2"/>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <h3 class="text-base font-medium text-gray-900 dark:text-gray-100">No Records Found</h3>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm">No attendance records found for the selected criteria.</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                        <!-- Summary Footer -->
                        {% if attendance_records %}
                        <tfoot class="bg-gray-100 dark:bg-gray-700 border-t-2 border-gray-300 dark:border-gray-600">
                            <tr>
                                <td class="px-3 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600 no-print"></td>
                                <td colspan="4" class="px-3 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600">
                                    SUMMARY TOTALS
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-gray-600 dark:text-gray-400">Total Records</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-blue-600 dark:text-blue-400" id="total-records-count">{{ summary_stats.total_records }}</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-blue-600 dark:text-blue-400" id="total-working-hours">0h</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-red-600 dark:text-red-400" id="total-late-minutes">0m</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-green-600 dark:text-green-400" id="total-overtime-minutes">0m</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-gray-600 dark:text-gray-400">Shifts</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-2 justify-center text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">New: <span id="summary-new-count">{{ summary_stats.new_records }}</span></span>
                                        <span class="text-gray-600 dark:text-gray-400">Existing: <span id="summary-existing-count">{{ summary_stats.existing_records }}</span></span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-2 justify-center text-xs">
                                        <span class="text-green-600 dark:text-green-400">P: <span id="summary-present-count">{{ summary_stats.present_records }}</span></span>
                                        <span class="text-red-600 dark:text-red-400">A: <span id="summary-absent-count">{{ summary_stats.absent_records }}</span></span>
                                        <span class="text-yellow-600 dark:text-yellow-400">L: <span id="summary-late-count">{{ summary_stats.late_records }}</span></span>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 🔥 COMPLETELY FIXED Modal with ALL MISSING FIELDS -->
<div id="report-modal" class="fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-gray-900 mx-auto mt-5 p-0 border border-gray-200 dark:border-gray-700 rounded-xl w-11/12 max-w-6xl shadow-2xl relative">
        <div class="bg-white dark:bg-gray-900 px-6 pt-6 pb-0 border-b border-gray-200 dark:border-gray-700 rounded-t-xl relative">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">🔥 Generate Comprehensive Attendance Report - ALL FIELDS FIXED</h2>
            <button type="button" class="modal-close-btn absolute right-4 top-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 border-0 rounded-lg w-8 h-8 flex items-center justify-center cursor-pointer transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="bg-white dark:bg-gray-900 px-6 py-6 max-h-[80vh] overflow-y-auto rounded-b-xl">
            <form id="report-form" method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Tab Navigation -->
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mb-6">
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm" data-tab="basic">Basic Settings</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="employee">Employee Filter</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="rules">Enhanced Rules</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="advanced">Advanced Options</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="weekend">Weekend & Breaks</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="missing">🔥 New Fields</button>
                </div>

                <!-- Basic Settings Tab -->
                <div class="tab-content" id="basic">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">📅 Date Range</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
                                    <input type="date" id="start_date" name="start_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required>
                                </div>
                                <div>
                                    <label for="end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date</label>
                                    <input type="date" id="end_date" name="end_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">⏰ Time Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="grace_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grace Minutes</label>
                                    <input type="number" id="grace_minutes" name="grace_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="15" min="0" max="120">
                                </div>
                                <div>
                                    <label for="early_out_threshold_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Early Out Threshold (Minutes)</label>
                                    <input type="number" id="early_out_threshold_minutes" name="early_out_threshold_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="30" min="0" max="240">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">💼 Overtime Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="overtime_start_after_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Overtime Start After (Minutes)</label>
                                    <input type="number" id="overtime_start_after_minutes" name="overtime_start_after_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="15" min="0" max="120">
                                </div>
                                <div>
                                    <label for="minimum_overtime_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Overtime (Minutes)</label>
                                    <input type="number" id="minimum_overtime_minutes" name="minimum_overtime_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="60" min="0" max="480">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Filter Tab -->
                <div class="tab-content hidden" id="employee">
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">👥 Employee Selection</h4>
                        <div class="space-y-4">
                            <div>
                                <label for="employee_filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Filter</label>
                                <select id="employee_filter" name="employee_filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                    <option value="all">All Active Employees</option>
                                    <option value="department">Filter by Department</option>
                                    <option value="designation">Filter by Designation</option>
                                    <option value="specific">Specific Employee IDs</option>
                                </select>
                            </div>
                            
                            <div id="department_filter" class="hidden">
                                <label for="departments" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Departments</label>
                                <select name="departments" multiple class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" size="5">
                                    {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div id="designation_filter" class="hidden">
                                <label for="designations" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Designations</label>
                                <select name="designations" multiple class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" size="5">
                                    {% for desig in designations %}
                                    <option value="{{ desig.id }}">{{ desig.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div id="employee_filter_specific" class="hidden">
                                <label for="employee_ids" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee IDs (comma-separated)</label>
                                <input type="text" name="employee_ids" placeholder="EMP001, EMP002, EMP003" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Rules Tab -->
                <div class="tab-content hidden" id="rules">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Working Hours Rules - FIXED NAMES</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_minimum_working_hours_rule" name="enable_minimum_working_hours_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_minimum_working_hours_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Minimum Working Hours Rule</label>
                                </div>
                                <div>
                                    <label for="minimum_working_hours_for_present" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">✅ Minimum Working Hours For Present</label>
                                    <input type="number" id="minimum_working_hours_for_present" name="minimum_working_hours_for_present" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="4.0" min="1.0" max="12.0" step="0.5">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_working_hours_half_day_rule" name="enable_working_hours_half_day_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_working_hours_half_day_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Working Hours Half Day Rule</label>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="half_day_minimum_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">✅ Half Day Minimum Hours</label>
                                        <input type="number" id="half_day_minimum_hours" name="half_day_minimum_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="2.0" min="1.0" max="4.0" step="0.5">
                                    </div>
                                    <div>
                                        <label for="half_day_maximum_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">✅ Half Day Maximum Hours</label>
                                        <input type="number" id="half_day_maximum_hours" name="half_day_maximum_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="4.0" min="2.0" max="6.0" step="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Validation Rules - FIXED NAMES</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="require_both_in_and_out" name="require_both_in_and_out" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="require_both_in_and_out" class="ml-2 text-sm text-gray-700 dark:text-gray-300">✅ Both Check-In & Check-Out Required</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_maximum_working_hours_rule" name="enable_maximum_working_hours_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_maximum_working_hours_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Maximum Working Hours Rule</label>
                                </div>
                                <div>
                                    <label for="maximum_allowable_working_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">✅ Maximum Allowable Working Hours</label>
                                    <input type="number" id="maximum_allowable_working_hours" name="maximum_allowable_working_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="12.0" min="8.0" max="24.0" step="0.5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Options Tab -->
                <div class="tab-content hidden" id="advanced">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Advanced Processing</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_dynamic_shift_detection" name="enable_dynamic_shift_detection" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <label for="enable_dynamic_shift_detection" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Dynamic Shift Detection</label>
                                </div>
                                <div>
                                    <label for="dynamic_shift_tolerance_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dynamic Shift Tolerance (Minutes)</label>
                                    <input type="number" id="dynamic_shift_tolerance_minutes" name="dynamic_shift_tolerance_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="30" min="5" max="120">
                                </div>
                                
                                <div>
                                    <label for="multiple_shift_priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Multiple Shift Priority</label>
                                    <select id="multiple_shift_priority" name="multiple_shift_priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="least_break">Least Break Time</option>
                                        <option value="shortest_duration">Shortest Duration</option>
                                        <option value="alphabetical">Alphabetical</option>
                                        <option value="highest_score">Highest Score</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Overtime Configuration</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="overtime_calculation_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Overtime Calculation Method</label>
                                    <select id="overtime_calculation_method" name="overtime_calculation_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="shift_based">Shift Based</option>
                                        <option value="hours_based">Hours Based</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="holiday_overtime_full_day" name="holiday_overtime_full_day" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="holiday_overtime_full_day" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Holiday Overtime Full Day</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="weekend_overtime_full_day" name="weekend_overtime_full_day" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="weekend_overtime_full_day" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Weekend Overtime Full Day</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="late_affects_overtime" name="late_affects_overtime" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="late_affects_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Late Affects Overtime</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekend & Breaks Tab -->
                <div class="tab-content hidden" id="weekend">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">📅 Weekend Configuration</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="0" id="monday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="monday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Monday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="1" id="tuesday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="tuesday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Tuesday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="2" id="wednesday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="wednesday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Wednesday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="3" id="thursday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="thursday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Thursday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="4" id="friday" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="friday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Friday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="5" id="saturday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="saturday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Saturday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="6" id="sunday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sunday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Sunday</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">☕ Break Time Configuration</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_shift_break_time" name="use_shift_break_time" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_shift_break_time" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Shift Break Time</label>
                                </div>
                                
                                <div>
                                    <label for="default_break_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Default Break Minutes</label>
                                    <input type="number" id="default_break_minutes" name="default_break_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="60" min="0" max="180">
                                </div>
                                
                                <div>
                                    <label for="break_deduction_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Break Deduction Method</label>
                                    <select id="break_deduction_method" name="break_deduction_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="fixed">Fixed</option>
                                        <option value="proportional">Proportional</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="separate_ot_break_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Separate OT Break Time (Minutes)</label>
                                    <input type="number" id="separate_ot_break_time" name="separate_ot_break_time" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="0" min="0" max="120">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🔥 NEW TAB: Missing Fields -->
                <div class="tab-content hidden" id="missing">
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold text-red-800 dark:text-red-200 mb-2">🔥 ALL MISSING FIELDS ADDED</h3>
                        <p class="text-red-700 dark:text-red-300 text-sm">These fields were missing from the original form but are now added to match UnifiedAttendanceProcessor exactly.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Dynamic Shift Settings -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Dynamic Shift Settings</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="dynamic_shift_fallback_to_default" name="dynamic_shift_fallback_to_default" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="dynamic_shift_fallback_to_default" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Dynamic Shift Fallback to Default</label>
                                </div>
                                
                                <div>
                                    <label for="dynamic_shift_fallback_shift_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dynamic Shift Fallback Shift ID</label>
                                    <input type="number" id="dynamic_shift_fallback_shift_id" name="dynamic_shift_fallback_shift_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" min="1">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_shift_grace_time" name="use_shift_grace_time" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_shift_grace_time" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Shift Grace Time</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Absence & Early Out Rules -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Absence & Early Out Rules</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="consecutive_absence_termination_risk_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Consecutive Absence Termination Risk Days</label>
                                    <input type="number" id="consecutive_absence_termination_risk_days" name="consecutive_absence_termination_risk_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="5" min="1" max="30">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_consecutive_absence_flagging" name="enable_consecutive_absence_flagging" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_consecutive_absence_flagging" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Consecutive Absence Flagging</label>
                                </div>
                                
                                <div>
                                    <label for="max_early_out_threshold_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Early Out Threshold Minutes</label>
                                    <input type="number" id="max_early_out_threshold_minutes" name="max_early_out_threshold_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="120" min="30" max="480">
                                </div>
                                
                                <div>
                                    <label for="max_early_out_occurrences" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Early Out Occurrences</label>
                                    <input type="number" id="max_early_out_occurrences" name="max_early_out_occurrences" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="3" min="1" max="10">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_max_early_out_flagging" name="enable_max_early_out_flagging" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_max_early_out_flagging" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Max Early Out Flagging</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Rules -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Advanced Rules</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="late_to_absent_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Late to Absent Days</label>
                                    <input type="number" id="late_to_absent_days" name="late_to_absent_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="3" min="1" max="10">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="holiday_before_after_absent" name="holiday_before_after_absent" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="holiday_before_after_absent" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Holiday Before After Absent</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="weekend_before_after_absent" name="weekend_before_after_absent" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="weekend_before_after_absent" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Weekend Before After Absent</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="require_holiday_presence" name="require_holiday_presence" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="require_holiday_presence" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Require Holiday Presence</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Holiday & Employee Settings -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">🔥 Holiday & Employee Settings</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="include_holiday_analysis" name="include_holiday_analysis" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="include_holiday_analysis" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Include Holiday Analysis</label>
                                </div>
                                
                                <div>
                                    <label for="holiday_buffer_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Holiday Buffer Days</label>
                                    <input type="number" id="holiday_buffer_days" name="holiday_buffer_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="1" min="0" max="5">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_employee_specific_grace" name="use_employee_specific_grace" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_employee_specific_grace" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Specific Grace</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_employee_specific_overtime" name="use_employee_specific_overtime" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_employee_specific_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Specific Overtime</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_employee_expected_hours" name="use_employee_expected_hours" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_employee_expected_hours" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Expected Hours</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Buttons -->
                <div class="flex gap-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button type="submit" class="flex-1 sm:flex-initial inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 h-12 px-8 py-3 shadow-lg transition-all duration-200 transform hover:scale-105">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                            <path d="M9 17h6l3 3v-3h2V5H4v12h5zm-2 0H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v9a2 2 0 01-2 2h-1l-3 3-3-3z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        🔥 Generate Report with ALL Fields
                    </button>
                    <button type="button" class="modal-close-btn flex-1 sm:flex-initial inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-gray-600 text-white hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 h-12 px-8 py-3 shadow-sm transition-all duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div id="import-progress-modal" class="fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-gray-900 mx-auto mt-20 p-6 border border-gray-200 dark:border-gray-700 rounded-xl w-11/12 max-w-md shadow-2xl relative">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Importing Attendance Records</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Please wait while we process your request...</p>
            <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                <div id="import-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="import-status-text" class="text-sm text-gray-600 dark:text-gray-400">Preparing import...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Print.js CDN -->
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateReportBtn = document.getElementById('generate-report-btn');
    const reportModal = document.getElementById('report-modal');
    const reportForm = document.getElementById('report-form');
    const printTableBtn = document.getElementById('print-table-btn');
    const importProgressModal = document.getElementById('import-progress-modal');

    // Store attendance records data
    let attendanceRecords = [];

    // Initialize attendance records from template data
    {% if attendance_records %}
    attendanceRecords = [
        {% for record in attendance_records %}
        {
            employee_id: "{{ record.employee_id }}",
            employee_name: "{{ record.employee_name }}",
            date: "{{ record.date }}",
            status: "{{ record.status }}",
            check_in: "{{ record.check_in|default:'' }}",
            check_out: "{{ record.check_out|default:'' }}",
            working_hours: {{ record.working_hours|default:0 }},
            late_minutes: {{ record.late_minutes|default:0 }},
            overtime_minutes: {{ record.overtime_minutes|default:0 }},
            shift_name: "{{ record.shift_name|default:'No Shift' }}",
            is_duplicate: {{ record.is_duplicate|yesno:'true,false' }},
            selected: {{ record.selected|yesno:'true,false' }},
            remarks: "{{ record.remarks|default:'' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    {% endif %}

    // Initialize all functionality
    initializeModal();
    initializeTabs();
    setupFieldVisibility();
    setDefaultDates();
    initializeTableFunctionality();
    initializePrintFunctionality();
    initializeImportFunctionality();
    calculateSummaryTotals();
    initializeCopyFunctionality();
    initializeFilterFunctionality();

    function initializeModal() {
        // Open modal
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (reportModal) {
                    reportModal.classList.remove('hidden');
                }
            });
        }

        // Close modal handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-close-btn') || e.target.closest('.modal-close-btn')) {
                e.preventDefault();
                e.stopPropagation();
                closeModal();
            }
        });

        // Close on backdrop click
        if (reportModal) {
            reportModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                if (importProgressModal && !importProgressModal.classList.contains('hidden')) {
                    importProgressModal.classList.add('hidden');
                }
            }
        });

        function closeModal() {
            if (reportModal) {
                reportModal.classList.add('hidden');
            }
        }

        // Form submission
        if (reportForm) {
            reportForm.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loader mr-2"></div>Generating Report...';
                submitBtn.disabled = true;
                
                // Form will submit normally to your existing POST endpoint
            });
        }
    }

    function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const targetTab = this.dataset.tab;
                
                // Remove active class from all buttons
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                    btn.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                
                // Add active class to clicked button
                this.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                this.classList.remove('text-gray-600', 'dark:text-gray-400');
                
                // Hide all tab contents
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show target tab content
                const targetContent = document.getElementById(targetTab);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            });
        });
    }

    function setupFieldVisibility() {
        const employeeFilter = document.getElementById('employee_filter');
        if (employeeFilter) {
            employeeFilter.addEventListener('change', function() {
                const value = this.value;
                const departmentFilter = document.getElementById('department_filter');
                const designationFilter = document.getElementById('designation_filter');
                const employeeFilterSpecific = document.getElementById('employee_filter_specific');
                
                // Hide all filter options
                if (departmentFilter) departmentFilter.classList.add('hidden');
                if (designationFilter) designationFilter.classList.add('hidden');
                if (employeeFilterSpecific) employeeFilterSpecific.classList.add('hidden');
                
                // Show relevant filter option
                if (value === 'department' && departmentFilter) {
                    departmentFilter.classList.remove('hidden');
                } else if (value === 'designation' && designationFilter) {
                    designationFilter.classList.remove('hidden');
                } else if (value === 'specific' && employeeFilterSpecific) {
                    employeeFilterSpecific.classList.remove('hidden');
                }
            });
        }
    }

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = firstDay.toISOString().split('T')[0];
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = today.toISOString().split('T')[0];
        }
    }

    function initializeTableFunctionality() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const selectAllBtn = document.getElementById('select-all-btn');
        const selectNoneBtn = document.getElementById('select-none-btn');
        const selectNewBtn = document.getElementById('select-new-btn');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectionCount = document.getElementById('selection-count');

        // Initialize selection state
        updateSelectionCount();
        updateRowSelection();

        // Select all checkbox functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
            });
        }

        // Individual row checkbox functionality
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateRowAppearance(this);
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        });

        // Bulk selection buttons
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        if (selectNoneBtn) {
            selectNoneBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        if (selectNewBtn) {
            selectNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('.attendance-row');
                    const isDuplicate = row.dataset.isDuplicate === 'true';
                    checkbox.checked = !isDuplicate;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        function updateRowAppearance(checkbox) {
            const row = checkbox.closest('.attendance-row');
            if (checkbox.checked) {
                row.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'border-blue-200', 'dark:border-blue-700');
            } else {
                row.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'border-blue-200', 'dark:border-blue-700');
            }
        }

        function updateSelectionCount() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (selectionCount) {
                selectionCount.textContent = checkedCount;
            }
            
            // Update import button states
            const importSelectedBtn = document.getElementById('import-selected-btn');
            if (importSelectedBtn) {
                importSelectedBtn.disabled = checkedCount === 0;
                if (checkedCount === 0) {
                    importSelectedBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    importSelectedBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    importSelectedBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    importSelectedBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            }
        }

        function updateSelectAllCheckbox() {
            const totalCheckboxes = rowCheckboxes.length;
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            
            if (selectAllCheckbox) {
                if (checkedCount === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedCount === totalCheckboxes) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }
        }

        function updateRowSelection() {
            rowCheckboxes.forEach(checkbox => {
                updateRowAppearance(checkbox);
            });
        }
    }

    function initializePrintFunctionality() {
        if (printTableBtn) {
            printTableBtn.addEventListener('click', function() {
                const tableElement = document.getElementById('attendance-table');
                if (tableElement) {
                    printJS({
                        printable: 'attendance-table',
                        type: 'html',
                        header: '<h2>Attendance Import Report</h2>',
                        css: 'https://printjs-4de6.kxcdn.com/print.min.css',
                        scanStyles: false,
                        style: `
                            @media print {
                                .no-print { display: none !important; }
                                table { border-collapse: collapse; width: 100%; }
                                th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                                th { background-color: #f0f0f0; font-weight: bold; }
                                .inline-flex { display: inline-block; }
                            }
                        `,
                        onPrintDialogClose: function() {
                            console.log('Print dialog closed');
                        }
                    });
                }
            });
        }
    }

    function initializeImportFunctionality() {
        const importSelectedBtn = document.getElementById('import-selected-btn');
        const importAllBtn = document.getElementById('import-all-btn');
        const importNewBtn = document.getElementById('import-new-btn');

        if (importSelectedBtn) {
            importSelectedBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedRecords = getSelectedRecords();
                if (selectedRecords.length > 0) {
                    performImport(selectedRecords, 'selected');
                } else {
                    showToast('No records selected for import', 'warning');
                }
            });
        }

        if (importAllBtn) {
            importAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (attendanceRecords.length > 0) {
                    performImport(attendanceRecords, 'all');
                } else {
                    showToast('No records available for import', 'warning');
                }
            });
        }

        if (importNewBtn) {
            importNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const newRecords = attendanceRecords.filter(record => !record.is_duplicate);
                if (newRecords.length > 0) {
                    performImport(newRecords, 'new');
                } else {
                    showToast('No new records to import', 'warning');
                }
            });
        }

        function getSelectedRecords() {
            const selectedRecords = [];
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            checkedCheckboxes.forEach(checkbox => {
                const recordIndex = parseInt(checkbox.dataset.recordIndex);
                if (recordIndex >= 0 && recordIndex < attendanceRecords.length) {
                    selectedRecords.push(attendanceRecords[recordIndex]);
                }
            });
            
            return selectedRecords;
        }

        function performImport(records, importType) {
            if (records.length === 0) {
                showToast('No records to import', 'warning');
                return;
            }

            // Show progress modal
            showImportProgress();

            // Prepare data for import
            const importData = {
                attendance_data: records,
                import_type: importType
            };

            // Send to Django backend
            fetch('{% url "hrm:attendance-import-save" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(importData)
            })
            .then(response => response.json())
            .then(data => {
                hideImportProgress();
                
                if (data.success) {
                    showToast(
                        `Import completed successfully! ${data.saved_count} records saved, ${data.updated_count} records updated.`,
                        'success'
                    );
                    
                    // Update UI to reflect imported records
                    updateImportStatus(records);
                    
                    // Optionally reload the page to refresh data
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showToast(`Import failed: ${data.error}`, 'error');
                    if (data.errors && data.errors.length > 0) {
                        console.error('Import errors:', data.errors);
                    }
                }
            })
            .catch(error => {
                hideImportProgress();
                console.error('Import error:', error);
            });
        }

        function updateImportStatus(importedRecords) {
            importedRecords.forEach(record => {
                const rows = document.querySelectorAll('.attendance-row');
                rows.forEach(row => {
                    const employeeId = row.dataset.employeeId;
                    const date = row.dataset.date;
                    
                    if (employeeId === record.employee_id && date === record.date) {
                        // Update import status badge
                        const statusCell = row.querySelector('td:nth-last-child(2)');
                        if (statusCell) {
                            statusCell.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Imported</span>';
                        }
                        
                        // Update row data
                        row.dataset.isDuplicate = 'true';
                        
                        // Uncheck the checkbox
                        const checkbox = row.querySelector('.row-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                            updateRowAppearance(checkbox);
                        }
                    }
                });
            });
            
            // Update selection count
            updateSelectionCount();
        }

        function showImportProgress() {
            if (importProgressModal) {
                importProgressModal.classList.remove('hidden');
                
                // Simulate progress
                let progress = 0;
                const progressBar = document.getElementById('import-progress-bar');
                const statusText = document.getElementById('import-status-text');
                
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress > 90) progress = 90;
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    
                    if (statusText) {
                        if (progress < 30) {
                            statusText.textContent = 'Validating records...';
                        } else if (progress < 60) {
                            statusText.textContent = 'Processing attendance data...';
                        } else {
                            statusText.textContent = 'Saving to database...';
                        }
                    }
                }, 200);
                
                // Store interval for cleanup
                importProgressModal.dataset.progressInterval = interval;
            }
        }

        function hideImportProgress() {
            if (importProgressModal) {
                // Clear progress interval
                const interval = importProgressModal.dataset.progressInterval;
                if (interval) {
                    clearInterval(interval);
                }
                
                // Complete progress bar
                const progressBar = document.getElementById('import-progress-bar');
                const statusText = document.getElementById('import-status-text');
                
                if (progressBar) {
                    progressBar.style.width = '100%';
                }
                
                if (statusText) {
                    statusText.textContent = 'Import completed!';
                }
                
                // Hide modal after a short delay
                setTimeout(() => {
                    importProgressModal.classList.add('hidden');
                }, 1000);
            }
        }

        function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }
    }

    function calculateSummaryTotals() {
        const rows = document.querySelectorAll('.attendance-row');
        let totalWorkingHours = 0;
        let totalLateMinutes = 0;
        let totalOvertimeMinutes = 0;

        rows.forEach(row => {
            const workingHours = parseFloat(row.dataset.workingHours) || 0;
            const lateMinutes = parseInt(row.dataset.lateMinutes) || 0;
            const overtimeMinutes = parseInt(row.dataset.overtimeMinutes) || 0;

            totalWorkingHours += workingHours;
            totalLateMinutes += lateMinutes;
            totalOvertimeMinutes += overtimeMinutes;
        });

        // Update summary footer
        const totalWorkingHoursElement = document.getElementById('total-working-hours');
        const totalLateMinutesElement = document.getElementById('total-late-minutes');
        const totalOvertimeMinutesElement = document.getElementById('total-overtime-minutes');

        if (totalWorkingHoursElement) {
            totalWorkingHoursElement.textContent = totalWorkingHours.toFixed(1) + 'h';
        }
        if (totalLateMinutesElement) {
            totalLateMinutesElement.textContent = totalLateMinutes + 'm';
        }
        if (totalOvertimeMinutesElement) {
            totalOvertimeMinutesElement.textContent = totalOvertimeMinutes + 'm';
        }
    }

    // 🔥 COPY TO CLIPBOARD FUNCTIONALITY
    function initializeCopyFunctionality() {
        const copyDropdownBtn = document.getElementById('copy-dropdown-btn');
        const copyDropdown = document.getElementById('copy-dropdown');
        const copyOptions = document.querySelectorAll('[data-copy]');

        // Toggle dropdown
        if (copyDropdownBtn) {
            copyDropdownBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                copyDropdown.classList.toggle('hidden');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!copyDropdownBtn.contains(e.target) && !copyDropdown.contains(e.target)) {
                copyDropdown.classList.add('hidden');
            }
        });

        // Handle copy options
        copyOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const copyType = this.dataset.copy;
                handleCopyAction(copyType);
                copyDropdown.classList.add('hidden');
            });
        });

        function handleCopyAction(type) {
            let textToCopy = '';
            
            switch (type) {
                case 'selected':
                    textToCopy = getSelectedRecordsText();
                    break;
                case 'visible':
                    textToCopy = getVisibleRecordsText();
                    break;
                case 'all':
                    textToCopy = getAllRecordsText();
                    break;
                case 'summary':
                    textToCopy = getSummaryText();
                    break;
                case 'employee-ids':
                    textToCopy = getEmployeeIdsText();
                    break;
            }

            if (textToCopy) {
                copyToClipboard(textToCopy, type);
            } else {
                showToast('No data to copy', 'warning');
            }
        }

        function getSelectedRecordsText() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            if (selectedRows.length === 0) return '';

            let text = 'Employee ID\tEmployee Name\tDate\tStatus\tCheck In\tCheck Out\tWorking Hours\tLate Minutes\tOvertime\tShift\n';
            
            selectedRows.forEach(checkbox => {
                const row = checkbox.closest('.attendance-row');
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[1].textContent.trim(), // Employee ID
                    cells[2].textContent.trim(), // Employee Name
                    cells[3].textContent.trim(), // Date
                    cells[4].textContent.trim().replace(/\s+/g, ' '), // Status (clean up spacing)
                    cells[5].textContent.trim(), // Check In
                    cells[6].textContent.trim(), // Check Out
                    cells[7].textContent.trim(), // Working Hours
                    cells[8].textContent.trim(), // Late Minutes
                    cells[9].textContent.trim(), // Overtime
                    cells[10].textContent.trim() // Shift
                ];
                text += rowData.join('\t') + '\n';
            });

            return text;
        }

        function getVisibleRecordsText() {
            const visibleRows = document.querySelectorAll('.attendance-row:not([style*="display: none"])');
            if (visibleRows.length === 0) return '';

            let text = 'Employee ID\tEmployee Name\tDate\tStatus\tCheck In\tCheck Out\tWorking Hours\tLate Minutes\tOvertime\tShift\n';
            
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[1].textContent.trim(), // Employee ID
                    cells[2].textContent.trim(), // Employee Name
                    cells[3].textContent.trim(), // Date
                    cells[4].textContent.trim().replace(/\s+/g, ' '), // Status
                    cells[5].textContent.trim(), // Check In
                    cells[6].textContent.trim(), // Check Out
                    cells[7].textContent.trim(), // Working Hours
                    cells[8].textContent.trim(), // Late Minutes
                    cells[9].textContent.trim(), // Overtime
                    cells[10].textContent.trim() // Shift
                ];
                text += rowData.join('\t') + '\n';
            });

            return text;
        }

        function getAllRecordsText() {
            const allRows = document.querySelectorAll('.attendance-row');
            if (allRows.length === 0) return '';

            let text = 'Employee ID\tEmployee Name\tDate\tStatus\tCheck In\tCheck Out\tWorking Hours\tLate Minutes\tOvertime\tShift\n';
            
            allRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[1].textContent.trim(), // Employee ID
                    cells[2].textContent.trim(), // Employee Name
                    cells[3].textContent.trim(), // Date
                    cells[4].textContent.trim().replace(/\s+/g, ' '), // Status
                    cells[5].textContent.trim(), // Check In
                    cells[6].textContent.trim(), // Check Out
                    cells[7].textContent.trim(), // Working Hours
                    cells[8].textContent.trim(), // Late Minutes
                    cells[9].textContent.trim(), // Overtime
                    cells[10].textContent.trim() // Shift
                ];
                text += rowData.join('\t') + '\n';
            });

            return text;
        }

        function getSummaryText() {
            return `Attendance Import Summary
Total Records: {{ summary_stats.total_records }}
Present: {{ summary_stats.present_records }}
Absent: {{ summary_stats.absent_records }}
Late: {{ summary_stats.late_records }}
Leave: {{ summary_stats.leave_records }}
Holiday: {{ summary_stats.holiday_records }}
Half Day: {{ summary_stats.half_day_records }}
New Records: {{ summary_stats.new_records }}
Existing Records: {{ summary_stats.existing_records }}
Date Range: {{ start_date }} to {{ end_date }}`;
        }

        function getEmployeeIdsText() {
            const visibleRows = document.querySelectorAll('.attendance-row:not([style*="display: none"])');
            const employeeIds = new Set();
            
            visibleRows.forEach(row => {
                const employeeId = row.querySelector('td:nth-child(2)').textContent.trim();
                employeeIds.add(employeeId);
            });

            return Array.from(employeeIds).join(', ');
        }

        function copyToClipboard(text, type) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(type);
                }).catch(() => {
                    fallbackCopyToClipboard(text, type);
                });
            } else {
                fallbackCopyToClipboard(text, type);
            }
        }

        function fallbackCopyToClipboard(text, type) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess(type);
            } catch (err) {
                showToast('Failed to copy to clipboard', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function showCopySuccess(type) {
            const typeNames = {
                'selected': 'Selected records',
                'visible': 'Visible records',
                'all': 'All records',
                'summary': 'Summary',
                'employee-ids': 'Employee IDs'
            };
            
            showToast(`${typeNames[type]} copied to clipboard!`, 'success');
        }
    }

    // 🔥 FILTER FUNCTIONALITY
    function initializeFilterFunctionality() {
        const statusFilters = document.querySelectorAll('.status-filter-badge');
        const searchInput = document.getElementById('search-input');
        const dateFilter = document.getElementById('date-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const activeFilters = document.getElementById('active-filters');
        const activeFiltersList = document.getElementById('active-filters-list');

        let currentFilters = {
            status: 'all',
            search: '',
            date: 'all'
        };

        // Status filter functionality
        statusFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                // Remove active class from all filters
                statusFilters.forEach(f => f.classList.remove('active'));
                // Add active class to clicked filter
                this.classList.add('active');
                
                currentFilters.status = this.dataset.status;
                applyFilters();
                updateActiveFilters();
            });
        });

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                currentFilters.search = this.value.toLowerCase();
                applyFilters();
                updateActiveFilters();
            });
        }

        // Date filter functionality
        if (dateFilter) {
            dateFilter.addEventListener('change', function() {
                currentFilters.date = this.value;
                applyFilters();
                updateActiveFilters();
            });
        }

        // Clear filters functionality
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                // Reset all filters
                currentFilters = { status: 'all', search: '', date: 'all' };
                
                // Reset UI elements
                statusFilters.forEach(f => f.classList.remove('active'));
                statusFilters[0].classList.add('active'); // First filter is "All"
                if (searchInput) searchInput.value = '';
                if (dateFilter) dateFilter.value = 'all';
                
                applyFilters();
                updateActiveFilters();
            });
        }

        function applyFilters() {
            const rows = document.querySelectorAll('.attendance-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                let shouldShow = true;
                
                // Status filter
                if (currentFilters.status !== 'all') {
                    const rowStatus = row.dataset.status;
                    if (rowStatus !== currentFilters.status) {
                        shouldShow = false;
                    }
                }
                
                // Search filter
                if (currentFilters.search && shouldShow) {
                    const employeeId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const employeeName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    
                    if (!employeeId.includes(currentFilters.search) && 
                        !employeeName.includes(currentFilters.search)) {
                        shouldShow = false;
                    }
                }
                
                // Date filter
                if (currentFilters.date !== 'all' && shouldShow) {
                    const rowDate = new Date(row.dataset.date);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    switch (currentFilters.date) {
                        case 'today':
                            if (rowDate.toDateString() !== today.toDateString()) {
                                shouldShow = false;
                            }
                            break;
                        case 'yesterday':
                            if (rowDate.toDateString() !== yesterday.toDateString()) {
                                shouldShow = false;
                            }
                            break;
                        case 'this-week':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay());
                            if (rowDate < weekStart || rowDate > today) {
                                shouldShow = false;
                            }
                            break;
                        case 'last-week':
                            const lastWeekStart = new Date(today);
                            lastWeekStart.setDate(today.getDate() - today.getDay() - 7);
                            const lastWeekEnd = new Date(lastWeekStart);
                            lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                            if (rowDate < lastWeekStart || rowDate > lastWeekEnd) {
                                shouldShow = false;
                            }
                            break;
                    }
                }
                
                // Show/hide row
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update filter counts
            updateFilterCounts();
            
            // Show message if no results
            showNoResultsMessage(visibleCount === 0);
        }

        function updateFilterCounts() {
            const visibleRows = document.querySelectorAll('.attendance-row:not([style*="display: none"])');
            const statusCounts = {
                all: visibleRows.length,
                PRE: 0,
                ABS: 0,
                LAT: 0,
                LEA: 0,
                HOL: 0,
                HAL: 0
            };
            
            visibleRows.forEach(row => {
                const status = row.dataset.status;
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            });
            
            // Update count displays
            document.getElementById('count-all').textContent = statusCounts.all;
            document.getElementById('count-present').textContent = statusCounts.PRE;
            document.getElementById('count-absent').textContent = statusCounts.ABS;
            document.getElementById('count-late').textContent = statusCounts.LAT;
            document.getElementById('count-leave').textContent = statusCounts.LEA;
            document.getElementById('count-holiday').textContent = statusCounts.HOL;
            document.getElementById('count-half-day').textContent = statusCounts.HAL;
        }

        function updateActiveFilters() {
            const activeFilterTags = [];
            
            if (currentFilters.status !== 'all') {
                const statusNames = {
                    'PRE': 'Present',
                    'ABS': 'Absent',
                    'LAT': 'Late',
                    'LEA': 'Leave',
                    'HOL': 'Holiday',
                    'HAL': 'Half Day'
                };
                activeFilterTags.push({
                    type: 'status',
                    label: `Status: ${statusNames[currentFilters.status]}`,
                    value: currentFilters.status
                });
            }
            
            if (currentFilters.search) {
                activeFilterTags.push({
                    type: 'search',
                    label: `Search: "${currentFilters.search}"`,
                    value: currentFilters.search
                });
            }
            
            if (currentFilters.date !== 'all') {
                const dateNames = {
                    'today': 'Today',
                    'yesterday': 'Yesterday',
                    'this-week': 'This Week',
                    'last-week': 'Last Week'
                };
                activeFilterTags.push({
                    type: 'date',
                    label: `Date: ${dateNames[currentFilters.date]}`,
                    value: currentFilters.date
                });
            }
            
            if (activeFilterTags.length > 0) {
                activeFilters.classList.remove('hidden');
                activeFiltersList.innerHTML = activeFilterTags.map(tag => `
                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md">
                        ${tag.label}
                        <button class="hover:text-blue-600 dark:hover:text-blue-400" onclick="removeFilter('${tag.type}', '${tag.value}')">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </span>
                `).join('');
            } else {
                activeFilters.classList.add('hidden');
            }
        }

        function showNoResultsMessage(show) {
            let noResultsRow = document.getElementById('no-results-row');
            
            if (show) {
                if (!noResultsRow) {
                    const tbody = document.getElementById('attendance-tbody');
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="13" class="px-4 py-8 text-center text-sm border border-gray-200 dark:border-gray-600">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="rounded-full bg-gray-100 dark:bg-gray-700 p-4">
                                    <svg class="h-8 w-8 text-gray-400 dark:text-gray-500" viewBox="0 0 24 24" fill="none">
                                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="text-center">
                                    <h3 class="text-base font-medium text-gray-900 dark:text-gray-100">No Records Found</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">No attendance records match your current filters.</p>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(noResultsRow);
                }
                noResultsRow.style.display = '';
            } else {
                if (noResultsRow) {
                    noResultsRow.style.display = 'none';
                }
            }
        }

        // Global function for removing individual filters
        window.removeFilter = function(type, value) {
            switch (type) {
                case 'status':
                    currentFilters.status = 'all';
                    statusFilters.forEach(f => f.classList.remove('active'));
                    statusFilters[0].classList.add('active');
                    break;
                case 'search':
                    currentFilters.search = '';
                    if (searchInput) searchInput.value = '';
                    break;
                case 'date':
                    currentFilters.date = 'all';
                    if (dateFilter) dateFilter.value = 'all';
                    break;
            }
            
            applyFilters();
            updateActiveFilters();
        };

        // Initialize filters
        applyFilters();
        updateActiveFilters();
    }

    // 🔥 TOAST NOTIFICATION SYSTEM
    function showToast(message, type = 'info') {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${getToastIcon(type)}
                    </svg>
                    <span>${message}</span>
                </div>
                <button class="ml-4 hover:opacity-75" onclick="this.parentElement.parentElement.remove()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }

    function getToastIcon(type) {
        switch (type) {
            case 'success':
                return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
            case 'error':
                return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
            case 'warning':
                return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>';
            default:
                return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        }
    }
});
</script>
{% endblock %}
