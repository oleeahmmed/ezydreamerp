{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
<style>
/* Use your default theme variables */
.loader { 
    border: 3px solid hsl(var(--muted)); 
    border-top: 3px solid hsl(var(--primary)); 
    border-radius: 50%; 
    width: 20px; 
    height: 20px; 
    animation: spin 1s linear infinite; 
    display: inline-block;
}

@keyframes spin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
}

/* Print styles */
@media print {
    .no-print { display: none !important; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; font-weight: bold; }
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white dark:bg-gray-900 rounded-xl border-2 border-gray-200 dark:border-gray-700 shadow-lg p-4 sm:p-8 mb-6">
        <!-- Header -->
        <div class="mb-6 sm:mb-8 border-b border-gray-200 dark:border-gray-700 pb-4 sm:pb-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-xl bg-blue-600 text-white shadow-md">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{{ title }}</h1>
                        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">{{ subtitle }}</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="generate-report-btn" class="inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 px-6 py-3 shadow-md">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Generate Report
                    </button>
                    
                    {% if data_generated %}
                    <button id="print-table-btn" class="no-print inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 px-6 py-3 shadow-md">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Print PDF
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% include "common/toast.html" %}

        <!-- Results Section -->
        {% if data_generated %}
        <div class="mb-6">
            <!-- Enhanced Summary Stats -->
            <div class="bg-blue-600 text-white p-4 rounded-lg mb-4">
                <h4 class="text-lg font-bold mb-2">ðŸ”¥ COMPLETE Overtime Report Summary with ALL Features</h4>
                <div class="grid grid-cols-2 md:grid-cols-10 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold">{{ summary_stats.total_records }}</div>
                        <div class="opacity-90">Total Records</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-300">{{ summary_stats.approved_records }}</div>
                        <div class="opacity-90">Approved</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-300">{{ summary_stats.pending_records }}</div>
                        <div class="opacity-90">Pending</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-300">{{ summary_stats.rejected_records }}</div>
                        <div class="opacity-90">Rejected</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-300">{{ summary_stats.holiday_overtime_records }}</div>
                        <div class="opacity-90">Holiday OT</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-300">{{ summary_stats.weekend_overtime_records }}</div>
                        <div class="opacity-90">Weekend OT</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-300">{{ summary_stats.new_records }}</div>
                        <div class="opacity-90">New</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-300">{{ summary_stats.existing_records }}</div>
                        <div class="opacity-90">Existing</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-pink-300">{{ summary_stats.dynamic_shift_detections }}</div>
                        <div class="opacity-90">Dynamic Shifts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-amber-300">{{ summary_stats.flagged_records }}</div>
                        <div class="opacity-90">Flagged</div>
                    </div>
                </div>
                
                <!-- Additional Stats Row -->
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm mt-4 pt-4 border-t border-blue-500">
                    <div class="text-center">
                        <div class="text-lg font-bold text-emerald-300">{{ summary_stats.roster_day_usage }}</div>
                        <div class="opacity-90">Roster Days</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-teal-300">{{ summary_stats.roster_assignment_usage }}</div>
                        <div class="opacity-90">Roster Assignments</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-indigo-300">{{ summary_stats.default_shift_usage }}</div>
                        <div class="opacity-90">Default Shifts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-rose-300">{{ summary_stats.no_shift_days }}</div>
                        <div class="opacity-90">No Shift</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-lime-300">{{ summary_stats.converted_records }}</div>
                        <div class="opacity-90">Converted</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-orange-300">{{ summary_stats.total_overtime_hours|floatformat:1 }}h</div>
                        <div class="opacity-90">Total OT Hours</div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4 no-print">
                <div class="flex flex-wrap items-center gap-4">
                    <!-- Selection Controls -->
                    <div class="flex items-center gap-2">
                        <button id="select-all-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 transition-colors">
                            Select All
                        </button>
                        <button id="select-none-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md border border-gray-300 dark:border-gray-600 transition-colors">
                            Select None
                        </button>
                        <button id="select-new-btn" class="px-3 py-2 text-sm bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 rounded-md border border-blue-300 dark:border-blue-600 transition-colors">
                            Select New
                        </button>
                        <button id="select-flagged-btn" class="px-3 py-2 text-sm bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 rounded-md border border-red-300 dark:border-red-600 transition-colors">
                            Select Flagged
                        </button>
                        <button id="select-dynamic-btn" class="px-3 py-2 text-sm bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:hover:bg-purple-800 text-purple-700 dark:text-purple-300 rounded-md border border-purple-300 dark:border-purple-600 transition-colors">
                            Select Dynamic
                        </button>
                    </div>
                    
                    <!-- Selection Info -->
                    <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span id="selection-count">0</span> records selected
                    </div>
                    
                    <!-- Import Buttons -->
                    <div class="flex items-center gap-2">
                        <button id="import-selected-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-md transition-colors" disabled>
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import Selected
                        </button>
                        <button id="import-all-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import All
                        </button>
                        <button id="import-new-btn" class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import New Only
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Results Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700" id="overtime-table">
                <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                    <table class="w-full border-collapse min-w-max">
                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 no-print">
                                    <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">EMPLOYEE ID</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">EMPLOYEE NAME</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">DATE</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">START TIME</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">END TIME</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">HOURS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">STATUS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">TYPE</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">SHIFT</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">SHIFT SOURCE</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">DYNAMIC</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">FLAGS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">IMPORT STATUS</th>
                                <th class="px-3 py-3 text-xs font-medium text-center border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">REASON</th>
                            </tr>
                        </thead>
                        <tbody id="overtime-tbody">
                            {% for record in overtime_records %}
                            <tr class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors overtime-row" 
                                data-employee-id="{{ record.employee_id }}"
                                data-date="{{ record.date }}"
                                data-hours="{{ record.hours }}"
                                data-is-duplicate="{{ record.is_duplicate|yesno:'true,false' }}"
                                data-selected="{{ record.selected|yesno:'true,false' }}"
                                data-is-holiday="{{ record.is_holiday|yesno:'true,false' }}"
                                data-is-weekend="{{ record.is_weekend|yesno:'true,false' }}"
                                data-dynamic-shift-used="{{ record.dynamic_shift_used|yesno:'true,false' }}"
                                data-flagged="{{ record.flagged|yesno:'true,false' }}"
                                data-converted="{{ record.converted|yesno:'true,false' }}">
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 no-print">
                                    <input type="checkbox" class="row-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                           {% if record.selected %}checked{% endif %}
                                           data-record-index="{{ forloop.counter0 }}">
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 font-medium text-gray-900 dark:text-gray-100">{{ record.employee_id }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.employee_name }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.date }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.start_time }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.end_time }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-blue-600 dark:text-blue-400">{{ record.hours|floatformat:1 }}h</span>
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.status == 'APP' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Approved</span>
                                    {% elif record.status == 'PEN' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>
                                    {% elif record.status == 'REJ' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Rejected</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.is_holiday %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">Holiday</span>
                                    {% elif record.is_weekend %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200">Weekend</span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Regular</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">{{ record.shift_name }}</td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.shift_source == 'RosterDay' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200">Roster Day</span>
                                    {% elif record.shift_source == 'RosterAssignment' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200">Roster Assignment</span>
                                    {% elif record.shift_source == 'Default' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">Default</span>
                                    {% elif record.shift_source == 'DynamicDetection' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200">Dynamic</span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">None</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.dynamic_shift_used %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">
                                            {{ record.shift_match_confidence|floatformat:0 }}%
                                        </span>
                                    {% else %}
                                        <span class="text-gray-500 dark:text-gray-400">--</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-1 justify-center">
                                        {% if record.flagged %}
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">ðŸš©</span>
                                        {% endif %}
                                        {% if record.converted %}
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">ðŸ”„</span>
                                        {% endif %}
                                        {% if not record.flagged and not record.converted %}
                                            <span class="text-gray-500 dark:text-gray-400">--</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-3 py-2 text-xs text-center border border-gray-200 dark:border-gray-600">
                                    {% if record.is_duplicate %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Imported</span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">New</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-xs border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">
                                    {% if record.reason %}
                                        <span class="text-gray-600 dark:text-gray-400" title="{{ record.reason }}">{{ record.reason|truncatechars:50 }}</span>
                                    {% else %}
                                        <span class="text-gray-500 dark:text-gray-500">--</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="15" class="px-4 py-8 text-center text-sm border border-gray-200 dark:border-gray-600">
                                    <div class="flex flex-col items-center justify-center space-y-4">
                                        <div class="rounded-full bg-gray-100 dark:bg-gray-700 p-4">
                                            <svg class="h-8 w-8 text-gray-400 dark:text-gray-500" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <h3 class="text-base font-medium text-gray-900 dark:text-gray-100">No Records Found</h3>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm">No overtime records found for the selected criteria.</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                        <!-- Enhanced Summary Footer -->
                        {% if overtime_records %}
                        <tfoot class="bg-gray-100 dark:bg-gray-700 border-t-2 border-gray-300 dark:border-gray-600">
                            <tr>
                                <td class="px-3 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600 no-print"></td>
                                <td colspan="4" class="px-3 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600">
                                    ðŸ”¥ COMPLETE SUMMARY TOTALS with ALL FEATURES
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-gray-600 dark:text-gray-400">Total Records</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="font-bold text-blue-600 dark:text-blue-400" id="total-overtime-hours">{{ summary_stats.total_overtime_hours|floatformat:1 }}h</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-2 justify-center text-xs">
                                        <span class="text-green-600 dark:text-green-400">A: <span id="summary-approved-count">{{ summary_stats.approved_records }}</span></span>
                                        <span class="text-yellow-600 dark:text-yellow-400">P: <span id="summary-pending-count">{{ summary_stats.pending_records }}</span></span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-2 justify-center text-xs">
                                        <span class="text-purple-600 dark:text-purple-400">H: <span id="summary-holiday-count">{{ summary_stats.holiday_overtime_records }}</span></span>
                                        <span class="text-cyan-600 dark:text-cyan-400">W: <span id="summary-weekend-count">{{ summary_stats.weekend_overtime_records }}</span></span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-gray-600 dark:text-gray-400">Shifts</span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-1 justify-center text-xs">
                                        <span class="text-emerald-600 dark:text-emerald-400">RD: {{ summary_stats.roster_day_usage }}</span>
                                        <span class="text-teal-600 dark:text-teal-400">RA: {{ summary_stats.roster_assignment_usage }}</span>
                                        <span class="text-indigo-600 dark:text-indigo-400">DF: {{ summary_stats.default_shift_usage }}</span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-pink-600 dark:text-pink-400">Dynamic: <span id="summary-dynamic-count">{{ summary_stats.dynamic_shift_detections }}</span></span>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-1 justify-center text-xs">
                                        <span class="text-red-600 dark:text-red-400">ðŸš©: {{ summary_stats.flagged_records }}</span>
                                        <span class="text-amber-600 dark:text-amber-400">ðŸ”„: {{ summary_stats.converted_records }}</span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <div class="flex gap-2 justify-center text-xs">
                                        <span class="text-blue-600 dark:text-blue-400">New: <span id="summary-new-count">{{ summary_stats.new_records }}</span></span>
                                        <span class="text-gray-600 dark:text-gray-400">Existing: <span id="summary-existing-count">{{ summary_stats.existing_records }}</span></span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-center border border-gray-200 dark:border-gray-600">
                                    <span class="text-gray-600 dark:text-gray-400">Records: <span id="total-records-count">{{ summary_stats.total_records }}</span></span>
                                </td>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ðŸ”¥ COMPLETE Overtime Report Modal with Organized Tabs -->
<div id="report-modal" class="fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-gray-900 mx-auto mt-5 p-0 border border-gray-200 dark:border-gray-700 rounded-xl w-11/12 max-w-7xl shadow-2xl relative">
        <div class="bg-white dark:bg-gray-900 px-6 pt-6 pb-0 border-b border-gray-200 dark:border-gray-700 rounded-t-xl relative">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">ðŸ”¥ COMPLETE Overtime Report with ALL Unified Processor Options</h2>
            <button type="button" class="modal-close-btn absolute right-4 top-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 border-0 rounded-lg w-8 h-8 flex items-center justify-center cursor-pointer transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="bg-white dark:bg-gray-900 px-6 py-6 max-h-[85vh] overflow-y-auto rounded-b-xl">
            <form id="report-form" method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Organized Tab Navigation - Only 5 Tabs -->
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mb-6">
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm" data-tab="basic">Basic & Employee</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="enhanced">ðŸ”¥ Enhanced Rules</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="overtime">ðŸ”¥ Overtime & Time</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="advanced">ðŸ”¥ Advanced & Flags</button>
                    <button type="button" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="weekend">Weekend & Holidays</button>
                </div>

                <!-- Basic & Employee Tab -->
                <div class="tab-content" id="basic">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Date Range & Basic Settings -->
                        <div class="space-y-6">
                            <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ“… Date Range & Basic Settings</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
                                        <input type="date" id="start_date" name="start_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required>
                                    </div>
                                    <div>
                                        <label for="end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date</label>
                                        <input type="date" id="end_date" name="end_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required>
                                    </div>
                                    <div>
                                        <label for="grace_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grace Minutes</label>
                                        <input type="number" id="grace_minutes" name="grace_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="15" min="0" max="120">
                                    </div>
                                    <div>
                                        <label for="early_out_threshold_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Early Out Threshold (Minutes)</label>
                                        <input type="number" id="early_out_threshold_minutes" name="early_out_threshold_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="30" min="0" max="240">
                                    </div>
                                </div>
                                
                                <div class="mt-4 space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="auto_calculate_from_attendance" name="auto_calculate_from_attendance" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="auto_calculate_from_attendance" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Auto Calculate from Attendance</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="require_attendance_record" name="require_attendance_record" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="require_attendance_record" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Require Existing Attendance Record</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Employee Filter -->
                        <div class="space-y-6">
                            <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ‘¥ Employee Selection</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label for="employee_filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Filter</label>
                                        <select id="employee_filter" name="employee_filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                            <option value="all">All Active Employees</option>
                                            <option value="department">Filter by Department</option>
                                            <option value="designation">Filter by Designation</option>
                                            <option value="specific">Specific Employee IDs</option>
                                        </select>
                                    </div>
                                    
                                    <div id="department_filter" class="hidden">
                                        <label for="departments" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Departments</label>
                                        <select name="departments" multiple class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" size="5">
                                            {% for dept in departments %}
                                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div id="designation_filter" class="hidden">
                                        <label for="designations" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Designations</label>
                                        <select name="designations" multiple class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" size="5">
                                            {% for desig in designations %}
                                            <option value="{{ desig.id }}">{{ desig.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div id="employee_filter_specific" class="hidden">
                                        <label for="employee_ids" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee IDs (comma-separated)</label>
                                        <input type="text" name="employee_ids" placeholder="EMP001, EMP002, EMP003" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Rules Tab -->
                <div class="tab-content hidden" id="enhanced">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Working Hours Rules -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ”¥ Working Hours Rules</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_minimum_working_hours_rule" name="enable_minimum_working_hours_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_minimum_working_hours_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Minimum Working Hours Rule</label>
                                </div>
                                <div>
                                    <label for="minimum_working_hours_threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Working Hours Threshold</label>
                                    <input type="number" id="minimum_working_hours_threshold" name="minimum_working_hours_threshold" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="4.0" min="1.0" max="12.0" step="0.5">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_working_hours_half_day_rule" name="enable_working_hours_half_day_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_working_hours_half_day_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Working Hours Half Day Rule</label>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="half_day_min_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Half Day Min Hours</label>
                                        <input type="number" id="half_day_min_hours" name="half_day_min_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="2.0" min="1.0" max="4.0" step="0.5">
                                    </div>
                                    <div>
                                        <label for="half_day_max_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Half Day Max Hours</label>
                                        <input type="number" id="half_day_max_hours" name="half_day_max_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="4.0" min="2.0" max="6.0" step="0.5">
                                    </div>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_both_in_out_required_rule" name="enable_both_in_out_required_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_both_in_out_required_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Both Check-In & Check-Out Required</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_maximum_working_hours_rule" name="enable_maximum_working_hours_rule" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_maximum_working_hours_rule" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Maximum Working Hours Rule</label>
                                </div>
                                <div>
                                    <label for="maximum_working_hours_threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maximum Working Hours Threshold</label>
                                    <input type="number" id="maximum_working_hours_threshold" name="maximum_working_hours_threshold" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="12.0" min="8.0" max="24.0" step="0.5">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dynamic Shift Detection -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ”¥ Dynamic Shift Detection</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_dynamic_shift_detection" name="enable_dynamic_shift_detection" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_dynamic_shift_detection" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Dynamic Shift Detection</label>
                                </div>
                                <div>
                                    <label for="dynamic_shift_tolerance_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dynamic Shift Tolerance (Minutes)</label>
                                    <input type="number" id="dynamic_shift_tolerance_minutes" name="dynamic_shift_tolerance_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="30" min="5" max="120">
                                </div>
                                
                                <div>
                                    <label for="multiple_shift_priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Multiple Shift Priority</label>
                                    <select id="multiple_shift_priority" name="multiple_shift_priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="least_break">Least Break Time</option>
                                        <option value="shortest_duration">Shortest Duration</option>
                                        <option value="alphabetical">Alphabetical</option>
                                        <option value="highest_score">Highest Score</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="dynamic_shift_fallback_to_default" name="dynamic_shift_fallback_to_default" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="dynamic_shift_fallback_to_default" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Fallback to Default Shift</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_shift_grace_time" name="use_shift_grace_time" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_shift_grace_time" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Shift Grace Time</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overtime & Time Tab -->
                <div class="tab-content hidden" id="overtime">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Overtime Settings -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">â° Overtime Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="overtime_start_after_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Overtime Start After (Minutes)</label>
                                    <input type="number" id="overtime_start_after_minutes" name="overtime_start_after_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="15" min="0" max="120">
                                </div>
                                <div>
                                    <label for="minimum_overtime_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Overtime (Minutes)</label>
                                    <input type="number" id="minimum_overtime_minutes" name="minimum_overtime_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="60" min="0" max="480">
                                </div>
                                <div>
                                    <label for="maximum_overtime_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maximum Overtime Hours</label>
                                    <input type="number" id="maximum_overtime_hours" name="maximum_overtime_hours" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="12.0" min="1.0" max="24.0" step="0.5">
                                </div>
                                <div>
                                    <label for="overtime_break_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Overtime Break Minutes</label>
                                    <input type="number" id="overtime_break_minutes" name="overtime_break_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="0" min="0" max="120">
                                </div>
                                
                                <div>
                                    <label for="overtime_calculation_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Calculation Method</label>
                                    <select id="overtime_calculation_method" name="overtime_calculation_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="attendance_based">Based on Attendance Records</option>
                                        <option value="shift_based">Shift Based</option>
                                        <option value="hours_based">Hours Based</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Break Time Configuration -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">â˜• Break Time Configuration</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="use_shift_break_time" name="use_shift_break_time" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="use_shift_break_time" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Shift Break Time</label>
                                </div>
                                
                                <div>
                                    <label for="default_break_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Default Break Minutes</label>
                                    <input type="number" id="default_break_minutes" name="default_break_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="60" min="0" max="180">
                                </div>
                                
                                <div>
                                    <label for="break_deduction_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Break Deduction Method</label>
                                    <select id="break_deduction_method" name="break_deduction_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                        <option value="fixed">Fixed</option>
                                        <option value="proportional">Proportional</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="separate_ot_break_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Separate OT Break Time (Minutes)</label>
                                    <input type="number" id="separate_ot_break_time" name="separate_ot_break_time" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="0" min="0" max="120">
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="holiday_overtime_full_day" name="holiday_overtime_full_day" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="holiday_overtime_full_day" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Holiday Overtime Full Day</label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="weekend_overtime_full_day" name="weekend_overtime_full_day" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="weekend_overtime_full_day" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Weekend Overtime Full Day</label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="late_affects_overtime" name="late_affects_overtime" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="late_affects_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Late Affects Overtime</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced & Flags Tab -->
                <div class="tab-content hidden" id="advanced">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Flagging Rules -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ”¥ Flagging & Risk Detection</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_consecutive_absence_flagging" name="enable_consecutive_absence_flagging" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_consecutive_absence_flagging" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Consecutive Absence Flagging</label>
                                </div>
                                <div>
                                    <label for="consecutive_absence_termination_risk_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Consecutive Absence Risk Days</label>
                                    <input type="number" id="consecutive_absence_termination_risk_days" name="consecutive_absence_termination_risk_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="5" min="3" max="30">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enable_max_early_out_flagging" name="enable_max_early_out_flagging" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="enable_max_early_out_flagging" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable Max Early Out Flagging</label>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="max_early_out_threshold_minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Early Out Threshold</label>
                                        <input type="number" id="max_early_out_threshold_minutes" name="max_early_out_threshold_minutes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="120" min="30" max="480">
                                    </div>
                                    <div>
                                        <label for="max_early_out_occurrences" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Occurrences</label>
                                        <input type="number" id="max_early_out_occurrences" name="max_early_out_occurrences" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="3" min="1" max="10">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Processing & Employee Override -->
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ”¥ Advanced Processing</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="late_to_absent_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Late to Absent Days</label>
                                    <input type="number" id="late_to_absent_days" name="late_to_absent_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="3" min="1" max="10">
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="holiday_before_after_absent" name="holiday_before_after_absent" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="holiday_before_after_absent" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Holiday Before/After Absent</label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="weekend_before_after_absent" name="weekend_before_after_absent" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="weekend_before_after_absent" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Weekend Before/After Absent</label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="require_holiday_presence" name="require_holiday_presence" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="require_holiday_presence" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Require Holiday Presence</label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="include_holiday_analysis" name="include_holiday_analysis" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="include_holiday_analysis" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Include Holiday Analysis</label>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="holiday_buffer_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Holiday Buffer Days</label>
                                    <input type="number" id="holiday_buffer_days" name="holiday_buffer_days" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="1" min="0" max="5">
                                </div>
                                
                                <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                                    <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Employee Override Settings</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="use_employee_specific_grace" name="use_employee_specific_grace" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label for="use_employee_specific_grace" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Specific Grace</label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" id="use_employee_specific_overtime" name="use_employee_specific_overtime" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label for="use_employee_specific_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Specific Overtime</label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" id="use_employee_expected_hours" name="use_employee_expected_hours" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label for="use_employee_expected_hours" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Use Employee Expected Hours</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekend & Holidays Tab -->
                <div class="tab-content hidden" id="weekend">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸ“… Weekend Configuration</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="0" id="monday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="monday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Monday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="1" id="tuesday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="tuesday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Tuesday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="2" id="wednesday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="wednesday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Wednesday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="3" id="thursday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="thursday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Thursday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="4" id="friday" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="friday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Friday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="5" id="saturday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="saturday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Saturday</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="weekend_days" value="6" id="sunday" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="sunday" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Sunday</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-4">ðŸŽ‰ Holiday & Weekend Overtime</h4>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="include_holiday_overtime" name="include_holiday_overtime" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="include_holiday_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Include Holiday Overtime</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="include_weekend_overtime" name="include_weekend_overtime" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="include_weekend_overtime" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Include Weekend Overtime</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Buttons - Always Visible -->
                <div class="flex gap-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button type="submit" class="flex-1 sm:flex-initial inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 h-12 px-8 py-3 shadow-lg transition-all duration-200 transform hover:scale-105">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                            <path d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        ðŸ”¥ Generate COMPLETE Report with ALL Features
                    </button>
                    <button type="button" class="modal-close-btn flex-1 sm:flex-initial inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-gray-600 text-white hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 h-12 px-8 py-3 shadow-sm transition-all duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div id="import-progress-modal" class="fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-gray-900 mx-auto mt-20 p-6 border border-gray-200 dark:border-gray-700 rounded-xl w-11/12 max-w-md shadow-2xl relative">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">ðŸ”¥ Importing COMPLETE Overtime Records</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Processing with ALL unified processor features...</p>
            <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                <div id="import-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="import-status-text" class="text-sm text-gray-600 dark:text-gray-400">Preparing import...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Print.js CDN -->
<script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateReportBtn = document.getElementById('generate-report-btn');
    const reportModal = document.getElementById('report-modal');
    const reportForm = document.getElementById('report-form');
    const printTableBtn = document.getElementById('print-table-btn');
    const importProgressModal = document.getElementById('import-progress-modal');

    // Store overtime records data with ALL features
    let overtimeRecords = [];
    
    // Initialize overtime records from template data with ALL fields
    {% if overtime_records %}
    overtimeRecords = [
        {% for record in overtime_records %}
        {
            employee_id: "{{ record.employee_id }}",
            employee_name: "{{ record.employee_name }}",
            date: "{{ record.date }}",
            start_time: "{{ record.start_time }}",
            end_time: "{{ record.end_time }}",
            hours: {{ record.hours }},
            reason: "{{ record.reason|default:'' }}",
            status: "{{ record.status }}",
            is_duplicate: {{ record.is_duplicate|yesno:'true,false' }},
            is_holiday: {{ record.is_holiday|yesno:'true,false' }},
            is_weekend: {{ record.is_weekend|yesno:'true,false' }},
            selected: {{ record.selected|yesno:'true,false' }},
            shift_name: "{{ record.shift_name|default:'No Shift' }}",
            shift_source: "{{ record.shift_source|default:'None' }}",
            dynamic_shift_used: {{ record.dynamic_shift_used|yesno:'true,false' }},
            shift_match_confidence: {{ record.shift_match_confidence|default:0 }},
            multiple_shifts_found: {{ record.multiple_shifts_found|default:"[]"|safe }},
            flagged: {{ record.flagged|yesno:'true,false' }},
            converted: {{ record.converted|yesno:'true,false' }},
            working_hours: {{ record.working_hours|default:0 }},
            late_minutes: {{ record.late_minutes|default:0 }},
            early_out_minutes: {{ record.early_out_minutes|default:0 }},
            break_time_minutes: {{ record.break_time_minutes|default:0 }},
            net_working_hours: {{ record.net_working_hours|default:0 }},
            overtime_break_minutes: {{ record.overtime_break_minutes|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    {% endif %}

    // Initialize all functionality with ALL features
    initializeModal();
    initializeTabs();
    setupFieldVisibility();
    setDefaultDates();
    initializeTableFunctionality();
    initializePrintFunctionality();
    initializeImportFunctionality();
    calculateSummaryTotals();

    function initializeModal() {
        // Open modal
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (reportModal) {
                    reportModal.classList.remove('hidden');
                }
            });
        }

        // Close modal handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-close-btn') || e.target.closest('.modal-close-btn')) {
                e.preventDefault();
                e.stopPropagation();
                closeModal();
            }
        });

        // Close on backdrop click
        if (reportModal) {
            reportModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                if (importProgressModal && !importProgressModal.classList.contains('hidden')) {
                    importProgressModal.classList.add('hidden');
                }
            }
        });

        function closeModal() {
            if (reportModal) {
                reportModal.classList.add('hidden');
            }
        }

        // Form submission
        if (reportForm) {
            reportForm.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loader mr-2"></div>ðŸ”¥ Generating COMPLETE Report...';
                submitBtn.disabled = true;
                
                // Form will submit normally to your existing POST endpoint
            });
        }
    }

    function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const targetTab = this.dataset.tab;
                
                // Remove active class from all buttons
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                    btn.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                
                // Add active class to clicked button
                this.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                this.classList.remove('text-gray-600', 'dark:text-gray-400');
                
                // Hide all tab contents
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show target tab content
                const targetContent = document.getElementById(targetTab);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            });
        });
    }

    function setupFieldVisibility() {
        const employeeFilter = document.getElementById('employee_filter');
        if (employeeFilter) {
            employeeFilter.addEventListener('change', function() {
                const value = this.value;
                const departmentFilter = document.getElementById('department_filter');
                const designationFilter = document.getElementById('designation_filter');
                const employeeFilterSpecific = document.getElementById('employee_filter_specific');
                
                // Hide all filter options
                if (departmentFilter) departmentFilter.classList.add('hidden');
                if (designationFilter) designationFilter.classList.add('hidden');
                if (employeeFilterSpecific) employeeFilterSpecific.classList.add('hidden');
                
                // Show relevant filter option
                if (value === 'department' && departmentFilter) {
                    departmentFilter.classList.remove('hidden');
                } else if (value === 'designation' && designationFilter) {
                    designationFilter.classList.remove('hidden');
                } else if (value === 'specific' && employeeFilterSpecific) {
                    employeeFilterSpecific.classList.remove('hidden');
                }
            });
        }
    }

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = firstDay.toISOString().split('T')[0];
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = today.toISOString().split('T')[0];
        }
    }

    function initializeTableFunctionality() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const selectAllBtn = document.getElementById('select-all-btn');
        const selectNoneBtn = document.getElementById('select-none-btn');
        const selectNewBtn = document.getElementById('select-new-btn');
        const selectFlaggedBtn = document.getElementById('select-flagged-btn');
        const selectDynamicBtn = document.getElementById('select-dynamic-btn');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectionCount = document.getElementById('selection-count');

        // Initialize selection state
        updateSelectionCount();
        updateRowSelection();

        // Select all checkbox functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
            });
        }

        // Individual row checkbox functionality
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateRowAppearance(this);
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        });

        // Bulk selection buttons with ALL features
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        if (selectNoneBtn) {
            selectNoneBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        if (selectNewBtn) {
            selectNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('.overtime-row');
                    const isDuplicate = row.dataset.isDuplicate === 'true';
                    checkbox.checked = !isDuplicate;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        // ðŸ”¥ NEW: Select flagged records
        if (selectFlaggedBtn) {
            selectFlaggedBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('.overtime-row');
                    const isFlagged = row.dataset.flagged === 'true';
                    checkbox.checked = isFlagged;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        // ðŸ”¥ NEW: Select dynamic shift records
        if (selectDynamicBtn) {
            selectDynamicBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rowCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('.overtime-row');
                    const isDynamic = row.dataset.dynamicShiftUsed === 'true';
                    checkbox.checked = isDynamic;
                    updateRowAppearance(checkbox);
                });
                updateSelectionCount();
                updateSelectAllCheckbox();
            });
        }

        function updateRowAppearance(checkbox) {
            const row = checkbox.closest('.overtime-row');
            if (checkbox.checked) {
                row.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'border-blue-200', 'dark:border-blue-700');
            } else {
                row.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'border-blue-200', 'dark:border-blue-700');
            }
        }

        function updateSelectionCount() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (selectionCount) {
                selectionCount.textContent = checkedCount;
            }
            
            // Update import button states
            const importSelectedBtn = document.getElementById('import-selected-btn');
            if (importSelectedBtn) {
                importSelectedBtn.disabled = checkedCount === 0;
                if (checkedCount === 0) {
                    importSelectedBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    importSelectedBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    importSelectedBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    importSelectedBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            }
        }

        function updateSelectAllCheckbox() {
            const totalCheckboxes = rowCheckboxes.length;
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            
            if (selectAllCheckbox) {
                if (checkedCount === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedCount === totalCheckboxes) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }
        }

        function updateRowSelection() {
            rowCheckboxes.forEach(checkbox => {
                updateRowAppearance(checkbox);
            });
        }
    }

    function initializePrintFunctionality() {
        if (printTableBtn) {
            printTableBtn.addEventListener('click', function() {
                const tableElement = document.getElementById('overtime-table');
                if (tableElement) {
                    printJS({
                        printable: 'overtime-table',
                        type: 'html',
                        header: '<h2>ðŸ”¥ COMPLETE Overtime Import Report with ALL Features</h2>',
                        css: 'https://printjs-4de6.kxcdn.com/print.min.css',
                        scanStyles: false,
                        style: `
                            @media print {
                                .no-print { display: none !important; }
                                table { border-collapse: collapse; width: 100%; }
                                th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                                th { background-color: #f0f0f0; font-weight: bold; }
                                .inline-flex { display: inline-block; }
                            }
                        `,
                        onPrintDialogClose: function() {
                            console.log('Print dialog closed');
                        }
                    });
                }
            });
        }
    }

    function initializeImportFunctionality() {
        const importSelectedBtn = document.getElementById('import-selected-btn');
        const importAllBtn = document.getElementById('import-all-btn');
        const importNewBtn = document.getElementById('import-new-btn');

        if (importSelectedBtn) {
            importSelectedBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedRecords = getSelectedRecords();
                if (selectedRecords.length > 0) {
                    performImport(selectedRecords, 'selected');
                } else {
                    showToast('No records selected for import', 'warning');
                }
            });
        }

        if (importAllBtn) {
            importAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (overtimeRecords.length > 0) {
                    performImport(overtimeRecords, 'all');
                } else {
                    showToast('No records available for import', 'warning');
                }
            });
        }

        if (importNewBtn) {
            importNewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const newRecords = overtimeRecords.filter(record => !record.is_duplicate);
                if (newRecords.length > 0) {
                    performImport(newRecords, 'new');
                } else {
                    showToast('No new records to import', 'warning');
                }
            });
        }

        function getSelectedRecords() {
            const selectedRecords = [];
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            checkedCheckboxes.forEach(checkbox => {
                const recordIndex = parseInt(checkbox.dataset.recordIndex);
                if (recordIndex >= 0 && recordIndex < overtimeRecords.length) {
                    selectedRecords.push(overtimeRecords[recordIndex]);
                }
            });
            
            return selectedRecords;
        }

        function performImport(records, importType) {
            if (records.length === 0) {
                showToast('No records to import', 'warning');
                return;
            }

            // Show progress modal
            showImportProgress();

            // Prepare data for import with ALL features
            const importData = {
                overtime_data: records,
                import_type: importType
            };

            // Send to Django backend
            fetch('{% url "hrm:overtime-import-save" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(importData)
            })
            .then(response => response.json())
            .then(data => {
                hideImportProgress();
                
                if (data.success) {
                    let message = `ðŸ”¥ COMPLETE Import completed successfully! ${data.saved_count} records saved, ${data.updated_count} records updated.`;
                    
                    // Add feature-specific stats
                    const savedRecords = data.saved_records || [];
                    const dynamicShiftCount = savedRecords.filter(r => r.dynamic_shift_used).length;
                    const flaggedCount = savedRecords.filter(r => r.flagged).length;
                    const convertedCount = savedRecords.filter(r => r.converted).length;
                    
                    if (dynamicShiftCount > 0) {
                        message += ` ${dynamicShiftCount} dynamic shifts detected.`;
                    }
                    if (flaggedCount > 0) {
                        message += ` ${flaggedCount} records flagged.`;
                    }
                    if (convertedCount > 0) {
                        message += ` ${convertedCount} records converted.`;
                    }
                    
                    showToast(message, 'success');
                    
                    // Update UI to reflect imported records
                    updateImportStatus(records);
                    
                    // Optionally reload the page to refresh data
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showToast(`Import failed: ${data.error}`, 'error');
                    if (data.errors && data.errors.length > 0) {
                        console.error('Import errors:', data.errors);
                    }
                }
            })
            .catch(error => {
                hideImportProgress();
                console.error('Import error:', error);
                // showToast('Import failed due to network error', 'error');
            });
        }

        function updateImportStatus(importedRecords) {
            importedRecords.forEach(record => {
                const rows = document.querySelectorAll('.overtime-row');
                rows.forEach(row => {
                    const employeeId = row.dataset.employeeId;
                    const date = row.dataset.date;
                    
                    if (employeeId === record.employee_id && date === record.date) {
                        // Update import status badge
                        const statusCell = row.querySelector('td:nth-last-child(2)');
                        if (statusCell) {
                            statusCell.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Imported</span>';
                        }
                        
                        // Update row data
                        row.dataset.isDuplicate = 'true';
                        
                        // Uncheck the checkbox
                        const checkbox = row.querySelector('.row-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                            updateRowAppearance(checkbox);
                        }
                    }
                });
            });
            
            // Update selection count
            updateSelectionCount();
        }

        function showImportProgress() {
            if (importProgressModal) {
                importProgressModal.classList.remove('hidden');
                
                // Simulate progress with ALL features
                let progress = 0;
                const progressBar = document.getElementById('import-progress-bar');
                const statusText = document.getElementById('import-status-text');
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    
                    if (statusText) {
                        if (progress < 20) {
                            statusText.textContent = 'ðŸ”¥ Validating overtime records with ALL rules...';
                        } else if (progress < 40) {
                            statusText.textContent = 'ðŸ”¥ Processing dynamic shift detection...';
                        } else if (progress < 60) {
                            statusText.textContent = 'ðŸ”¥ Applying enhanced validation rules...';
                        } else if (progress < 80) {
                            statusText.textContent = 'ðŸ”¥ Processing overtime calculations...';
                        } else {
                            statusText.textContent = 'ðŸ”¥ Saving to database with ALL features...';
                        }
                    }
                }, 200);
                
                // Store interval for cleanup
                importProgressModal.dataset.progressInterval = interval;
            }
        }

        function hideImportProgress() {
            if (importProgressModal) {
                // Clear progress interval
                const interval = importProgressModal.dataset.progressInterval;
                if (interval) {
                    clearInterval(interval);
                }
                
                // Complete progress bar
                const progressBar = document.getElementById('import-progress-bar');
                const statusText = document.getElementById('import-status-text');
                
                if (progressBar) {
                    progressBar.style.width = '100%';
                }
                
                if (statusText) {
                    statusText.textContent = 'ðŸ”¥ COMPLETE Import completed with ALL features!';
                }
                
                // Hide modal after a short delay
                setTimeout(() => {
                    importProgressModal.classList.add('hidden');
                }, 1500);
            }
        }

        function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
            
            // Set toast style based on type
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    toast.classList.add('bg-blue-500', 'text-white');
            }
            
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 6 seconds (longer for feature-rich messages)
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 6000);
        }
    }

    function calculateSummaryTotals() {
        const rows = document.querySelectorAll('.overtime-row');
        let totalOvertimeHours = 0;

        rows.forEach(row => {
            const hours = parseFloat(row.dataset.hours) || 0;
            totalOvertimeHours += hours;
        });

        // Update summary footer
        const totalOvertimeHoursElement = document.getElementById('total-overtime-hours');
        if (totalOvertimeHoursElement) {
            totalOvertimeHoursElement.textContent = totalOvertimeHours.toFixed(1) + 'h';
        }
    }
});
</script>
{% endblock %}
