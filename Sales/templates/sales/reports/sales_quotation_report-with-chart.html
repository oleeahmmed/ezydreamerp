{% extends "common/base-list-modern.html" %}
{% load static %}
{% load i18n %}

{% block list_icon %}
<svg class="w-6 h-6 sm:w-7 sm:h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 21 7 21 17 21C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15" stroke="currentColor" stroke-width="2"/>
    <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5C15 6.10457 14.1046 7 13 7H11C9.89543 7 9 6.10457 9 5Z" stroke="currentColor" stroke-width="2"/>
    <path d="M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>
{% endblock %}

{% block list_title %}{% trans "Sales Quotation Report" %}{% endblock %}
{% block list_subtitle %}{% trans "View summary of sales quotations" %}{% endblock %}

{% block list_actions %}
<div class="flex gap-2 flex-wrap">
    <button id="export-pdf" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 9H15V3H9V9H5L12 16L19 9Z" fill="currentColor"/><path d="M5 18H19V21H5V18Z" fill="currentColor"/></svg>
        {% trans "Export PDF" %}
    </button>
    <button id="export-csv" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" stroke="currentColor" stroke-width="2"/><path d="M8 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 14H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        {% trans "Export CSV" %}
    </button>
    <button id="pivot-table" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3H9V9H3V3Z" fill="currentColor"/><path d="M3 15H9V21H3V15Z" fill="currentColor"/><path d="M15 3H21V9H15V3Z" fill="currentColor"/><path d="M15 15H21V21H15V15Z" fill="currentColor"/></svg>
        {% trans "Pivot Table" %}
    </button>
    <button id="toggle-charts" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 15V3M10 15V7M15 15V10M20 15V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        {% trans "Toggle Charts" %}
    </button>
    <button id="customize-columns" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5H21M3 12H21M3 19H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        {% trans "Customize Columns" %}
    </button>
    <button id="manage-presets" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12H19M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        {% trans "Manage Presets" %}
    </button>
</div>
{% endblock %}

{% block search_filter %}
<div class="mb-6">
    <form method="get" id="filter-form" class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <div class="filters-container overflow-x-auto hide-scrollbar -mx-4 px-4 pb-2">
            <div class="flex flex-nowrap gap-3 min-w-max">
                <input type="text" name="search" value="{{ search_term }}" placeholder="{% trans 'Search Quotation ID...' %}" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                <input type="date" name="start_date" value="{{ start_date }}" placeholder="{% trans 'Start Date' %}" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                <input type="date" name="end_date" value="{{ end_date }}" placeholder="{% trans 'End Date' %}" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                <select name="customer" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                    <option value="">{% trans "All Customers" %}</option>
                    {% for customer in all_customers %}
                        <option value="{{ customer.id }}" {% if selected_customer.id == customer.id %}selected{% endif %}>{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <select name="sales_employee" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                    <option value="">{% trans "All Sales Employees" %}</option>
                    {% for employee in all_sales_employees %}
                        <option value="{{ employee.id }}" {% if selected_employee.id == employee.id %}selected{% endif %}>{{ employee.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 4H21M3 12H21M3 20H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {% trans "Filter" %}
                </button>
                <a href="{% url 'Sales:sales_quotation_report' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-[hsl(var(--border))] bg-[hsl(var(--background))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] h-10 px-4 py-2 whitespace-nowrap">
                    {% trans "Clear Filters" %}
                </a>
            </div>
        </div>
    </form>
    <!-- Charts Section -->
    <div id="charts-section" class="mb-6 hidden animate-slide-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Total Amount Chart -->
            <div class="bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-lg shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4 border-b border-[hsl(var(--border))]">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-[hsl(var(--foreground))]">{% trans "Total Amount by Month" %}</h3>
                        <div class="flex gap-2">
                            <select id="amount-chart-type" class="px-2 py-1 rounded-md border border-[hsl(var(--border))] bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm focus:outline-none focus:ring-2 focus:ring-[hsl(var(--primary))]">
                                <option value="bar">{% trans "Bar" %}</option>
                                <option value="line">{% trans "Line" %}</option>
                            </select>
                            <button id="export-amount-chart" class="text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--foreground))] p-1" title="{% trans 'Export as PNG' %}">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 9H15V3H9V9H5L12 16L19 9Z" stroke="currentColor" stroke-width="2"/><path d="M5 18H19V21H5V18Z" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="amount-chart-skeleton" class="h-64 bg-[hsl(var(--muted))] animate-pulse rounded-md"></div>
                    <canvas id="amount-chart" class="hidden"></canvas>
                </div>
            </div>
            <!-- Status Chart -->
            <div class="bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-lg shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4 border-b border-[hsl(var(--border))]">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-[hsl(var(--foreground))]">{% trans "Quotations by Status" %}</h3>
                        <div class="flex gap-2">
                            <select id="status-chart-type" class="px-2 py-1 rounded-md border border-[hsl(var(--border))] bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm focus:outline-none focus:ring-2 focus:ring-[hsl(var(--primary))]">
                                <option value="pie">{% trans "Pie" %}</option>
                                <option value="doughnut">{% trans "Doughnut" %}</option>
                            </select>
                            <button id="export-status-chart" class="text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--foreground))] p-1" title="{% trans 'Export as PNG' %}">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 9H15V3H9V9H5L12 16L19 9Z" stroke="currentColor" stroke-width="2"/><path d="M5 18H19V21H5V18Z" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="status-chart-skeleton" class="h-64 bg-[hsl(var(--muted))] animate-pulse rounded-md"></div>
                    <canvas id="status-chart" class="hidden"></canvas>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block table_headers %}
<th scope="col" class="px-3 sm:px-6 py-3" data-column="quotation">{% trans "Quotation #" %}</th>
<th scope="col" class="px-3 sm:px-6 py-3" data-column="date">{% trans "Date" %}</th>
<th scope="col" class="px-3 sm:px-6 py-3" data-column="customer">{% trans "Customer" %}</th>
<th scope="col" class="px-3 sm:px-6 py-3" data-column="sales_employee">{% trans "Sales Employee" %}</th>
<th scope="col" class="px-3 sm:px-6 py-3" data-column="total_amount">{% trans "Total Amount" %}</th>
<th scope="col" class="px-3 sm:px-6 py-3" data-column="status">{% trans "Status" %}</th>
{% endblock %}

{% block table_body %}
{% for quotation in quotations %}
<tr class="bg-[hsl(var(--background))] border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] transition-colors">
    <td class="px-3 sm:px-6 py-4" data-column="quotation">
        #{{ quotation.id }}
    </td>
    <td class="px-3 sm:px-6 py-4" data-column="date">
        {{ quotation.document_date }}
    </td>
    <td class="px-3 sm:px-6 py-4" data-column="customer">
        <div>
            <div class="font-medium">{{ quotation.customer.name }}</div>
            <div class="text-xs text-[hsl(var(--muted-foreground))]">{{ quotation.customer.code }}</div>
        </div>
    </td>
    <td class="px-3 sm:px-6 py-4" data-column="sales_employee">
        {{ quotation.sales_employee.name|default:"N/A" }}
    </td>
    <td class="px-3 sm:px-6 py-4" data-column="total_amount">
        {{ quotation.total_amount }}
    </td>
    <td class="px-3 sm:px-6 py-4" data-column="status">
        <span class="status-badge status-{{ quotation.status }}">
            {{ quotation.status }}
        </span>
    </td>
</tr>
{% empty %}
<tr class="bg-[hsl(var(--background))] border-b border-[hsl(var(--border))]">
    <td colspan="6" class="px-3 sm:px-6 py-4 text-center text-sm text-[hsl(var(--muted-foreground))]">
        {% trans "No quotations found for the selected date range." %}
    </td>
</tr>
{% endfor %}
{% if quotations %}
<tfoot class="bg-[hsl(var(--muted))] text-[hsl(var(--muted-foreground))] font-semibold">
    <tr>
        <td colspan="4" class="px-3 sm:px-6 py-3 text-right">{% trans "Total:" %}</td>
        <td class="px-3 sm:px-6 py-3">{{ total_amount }}</td>
        <td class="px-3 sm:px-6 py-3"></td>
    </tr>
</tfoot>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .status-Draft { background: hsl(var(--muted)); color: hsl(var(--muted-foreground)); }
    .status-Open { background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); }
    .status-Sent { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }
    .status-Expired { background: hsl(var(--destructive)); color: hsl(var(--destructive-foreground)); }
    .status-Converted { background: hsl(var(--accent)); color: hsl(var(--accent-foreground)); }
    .status-Closed { background: hsl(var(--muted)); color: hsl(var(--muted-foreground)); }
    .status-Cancelled { background: hsl(var(--destructive)); color: hsl(var(--destructive-foreground)); }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s ease-out;
    }
    .modal-content {
        background-color: hsl(var(--background));
        margin: 5% auto;
        padding: 20px;
        border: 1px solid hsl(var(--border));
        width: 90%;
        max-width: 600px;
        border-radius: var(--radius);
        position: relative;
        animation: slideIn 0.3s ease-out;
    }
    .modal-close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 24px;
        cursor: pointer;
        color: hsl(var(--foreground));
        transition: color 0.2s;
    }
    .modal-close:hover {
        color: hsl(var(--primary));
    }
    .sortable-column {
        padding: 10px;
        background: hsl(var(--muted));
        margin: 5px 0;
        border-radius: var(--radius);
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }
    .sortable-column:hover {
        background: hsl(var(--accent));
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in {
        animation: slideIn 0.3s ease-out;
    }
    .animate-pulse {
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
        }
        #charts-section canvas {
            max-height: 250px;
        }
        .grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const exportPdfButton = document.getElementById('export-pdf');
    const exportCsvButton = document.getElementById('export-csv');
    const pivotTableButton = document.getElementById('pivot-table');
    const toggleChartsButton = document.getElementById('toggle-charts');
    const customizeColumnsButton = document.getElementById('customize-columns');
    const managePresetsButton = document.getElementById('manage-presets');
    const chartsSection = document.getElementById('charts-section');
    const amountChartType = document.getElementById('amount-chart-type');
    const statusChartType = document.getElementById('status-chart-type');
    const exportAmountChart = document.getElementById('export-amount-chart');
    const exportStatusChart = document.getElementById('export-status-chart');

    const pivotModal = document.createElement('div');
    pivotModal.id = 'pivot-modal';
    pivotModal.className = 'modal';
    pivotModal.innerHTML = `
        <div id="pivot-modal-content" class="modal-content">
            <span id="pivot-close" class="modal-close">×</span>
            <h2 class="text-lg font-semibold text-[hsl(var(--foreground))]">{% trans "Sales Quotation Pivot Table" %}</h2>
            <div id="pivot-table-output"></div>
        </div>
    `;
    document.body.appendChild(pivotModal);

    const columnsModal = document.createElement('div');
    columnsModal.id = 'columns-modal';
    columnsModal.className = 'modal';
    columnsModal.innerHTML = `
        <div id="columns-modal-content" class="modal-content">
            <span id="columns-close" class="modal-close">×</span>
            <h2 class="text-lg font-semibold text-[hsl(var(--foreground))]">{% trans "Customize Columns" %}</h2>
            <p class="text-sm text-[hsl(var(--muted-foreground))]">{% trans "Select and reorder columns to display." %}</p>
            <ul id="sortable-columns" class="mt-4"></ul>
            <div class="mt-4 flex gap-2">
                <button id="save-columns" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))]">{% trans "Save" %}</button>
                <button id="reset-columns" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))]">{% trans "Reset to Default" %}</button>
            </div>
        </div>
    `;
    document.body.appendChild(columnsModal);

    const presetsModal = document.createElement('div');
    presetsModal.id = 'presets-modal';
    presetsModal.className = 'modal';
    presetsModal.innerHTML = `
        <div id="presets-modal-content" class="modal-content">
            <span id="presets-close" class="modal-close">×</span>
            <h2 class="text-lg font-semibold text-[hsl(var(--foreground))]">{% trans "Manage Presets" %}</h2>
            <p class="text-sm text-[hsl(var(--muted-foreground))]">{% trans "Save, load, update, or delete report presets." %}</p>
            <div class="mt-4">
                <input id="preset-name" type="text" placeholder="{% trans 'Preset Name' %}" class="px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-transparent text-[hsl(var(--foreground))] w-full mb-2 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))]">
                <button id="save-preset" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))] mb-4">{% trans "Save Current Preset" %}</button>
                <h3 class="text-md font-medium">{% trans "Saved Presets" %}</h3>
                <ul id="preset-list" class="mt-2"></ul>
            </div>
        </div>
    `;
    document.body.appendChild(presetsModal);

    const COLUMN_PREFS_KEY = 'sales_quotation_column_prefs';
    const PRESETS_KEY = 'sales_quotation_presets';
    const CHART_PREFS_KEY = 'sales_quotation_chart_prefs';

    const defaultColumns = [
        { id: 'quotation', label: 'Quotation #', visible: true },
        { id: 'date', label: 'Date', visible: true },
        { id: 'customer', label: 'Customer', visible: true },
        { id: 'sales_employee', label: 'Sales Employee', visible: true },
        { id: 'total_amount', label: 'Total Amount', visible: true },
        { id: 'status', label: 'Status', visible: true }
    ];

    const defaultChartPrefs = {
        amountChartType: 'bar',
        statusChartType: 'pie',
        chartsVisible: false
    };

    let amountChart, statusChart;
    function initializeCharts(data, amountType = 'bar', statusType = 'pie') {
        const months = [...new Set(data.map(item => new Date(item.date).toLocaleString('default', { month: 'long', year: 'numeric' })))].sort((a, b) => new Date(a) - new Date(b));
        const amountsByMonth = months.map(month => {
            return data.filter(item => new Date(item.date).toLocaleString('default', { month: 'long', year: 'numeric' }) === month)
                .reduce((sum, item) => sum + item.total_amount, 0);
        });

        const statusCounts = {};
        data.forEach(item => {
            statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
        });

        if (amountChart) amountChart.destroy();
        if (statusChart) statusChart.destroy();

        document.getElementById('amount-chart-skeleton').classList.remove('hidden');
        document.getElementById('status-chart-skeleton').classList.remove('hidden');
        document.getElementById('amount-chart').classList.add('hidden');
        document.getElementById('status-chart').classList.add('hidden');

        amountChart = new Chart(document.getElementById('amount-chart'), {
            type: amountType,
            data: {
                labels: months,
                datasets: [{
                    label: 'Total Amount',
                    data: amountsByMonth,
                    backgroundColor: amountType === 'line' ? 'transparent' : 'hsl(var(--primary) / 0.6)',
                    borderColor: 'hsl(var(--primary))',
                    borderWidth: amountType === 'line' ? 2 : 1,
                    tension: 0.4,
                    fill: amountType === 'line'
                }]
            },
            options: {
                responsive: true,
                animation: { duration: 1000, easing: 'easeOutQuart' },
                plugins: {
                    datalabels: { display: false },
                    tooltip: {
                        backgroundColor: 'hsl(var(--background))',
                        titleColor: 'hsl(var(--foreground))',
                        bodyColor: 'hsl(var(--foreground))',
                        borderColor: 'hsl(var(--border))',
                        borderWidth: 1,
                        callbacks: { label: ctx => `$${ctx.raw.toLocaleString()}` }
                    },
                    legend: { labels: { color: 'hsl(var(--foreground))' } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: 'hsl(var(--muted-foreground))', callback: value => `$${value.toLocaleString()}` },
                        grid: { color: 'hsl(var(--border) / 0.2)' }
                    },
                    x: {
                        ticks: { color: 'hsl(var(--muted-foreground))' },
                        grid: { display: false }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        statusChart = new Chart(document.getElementById('status-chart'), {
            type: statusType,
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['hsl(var(--primary))', 'hsl(var(--secondary))', 'hsl(var(--destructive))', 'hsl(var(--accent))', 'hsl(var(--muted))', 'hsl(var(--secondary-foreground))'],
                    borderColor: 'hsl(var(--background))',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                animation: { duration: 1000, easing: 'easeOutQuart' },
                plugins: {
                    datalabels: { color: 'hsl(var(--primary-foreground))', font: { weight: 'bold' }, formatter: value => value },
                    tooltip: {
                        backgroundColor: 'hsl(var(--background))',
                        titleColor: 'hsl(var(--foreground))',
                        bodyColor: 'hsl(var(--foreground))',
                        borderColor: 'hsl(var(--border))',
                        borderWidth: 1,
                        callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}` }
                    },
                    legend: { labels: { color: 'hsl(var(--foreground))' } }
                }
            },
            plugins: [ChartDataLabels]
        });

        setTimeout(() => {
            document.getElementById('amount-chart-skeleton').classList.add('hidden');
            document.getElementById('status-chart-skeleton').classList.add('hidden');
            document.getElementById('amount-chart').classList.remove('hidden');
            document.getElementById('status-chart').classList.remove('hidden');
        }, 500);
    }

    function updateCharts() {
        const rows = document.querySelectorAll('tbody tr:not(.hidden)');
        const data = Array.from(rows).map(row => {
            const cols = row.querySelectorAll('td');
            return {
                date: cols[1].textContent.trim(),
                total_amount: parseFloat(cols[4].textContent.trim()) || 0,
                status: cols[5].querySelector('span').textContent.trim()
            };
        });
        const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        if (data.length > 0) {
            initializeCharts(data, chartPrefs.amountChartType, chartPrefs.statusChartType);
        }
    }

    function saveChartPrefs(prefs) {
        localStorage.setItem(CHART_PREFS_KEY, JSON.stringify(prefs));
    }

    function loadChartPrefs() {
        const prefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        amountChartType.value = prefs.amountChartType;
        statusChartType.value = prefs.statusChartType;
        chartsSection.classList.toggle('hidden', !prefs.chartsVisible);
        if (prefs.chartsVisible) updateCharts();
    }

    toggleChartsButton.addEventListener('click', function() {
        chartsSection.classList.toggle('hidden');
        const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        chartPrefs.chartsVisible = !chartsSection.classList.contains('hidden');
        saveChartPrefs(chartPrefs);
        if (chartPrefs.chartsVisible) updateCharts();
    });

    amountChartType.addEventListener('change', function() {
        const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        chartPrefs.amountChartType = this.value;
        saveChartPrefs(chartPrefs);
        updateCharts();
    });

    statusChartType.addEventListener('change', function() {
        const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        chartPrefs.statusChartType = this.value;
        saveChartPrefs(chartPrefs);
        updateCharts();
    });

    function exportChart(canvasId, filename) {
        html2canvas(document.getElementById(canvasId).parentElement).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = filename;
            link.click();
        });
    }

    exportAmountChart.addEventListener('click', () => exportChart('amount-chart', 'total_amount_chart.png'));
    exportStatusChart.addEventListener('click', () => exportChart('status-chart', 'status_chart.png'));

    function loadColumnPrefs() {
        let prefs = JSON.parse(localStorage.getItem(COLUMN_PREFS_KEY)) || defaultColumns;
        applyColumnPrefs(prefs);
    }

    function applyColumnPrefs(prefs) {
        const headers = document.querySelectorAll('th');
        const rows = document.querySelectorAll('tbody tr');
        headers.forEach(header => {
            const colId = header.dataset.column;
            const pref = prefs.find(p => p.id === colId);
            header.style.display = pref && pref.visible ? '' : 'none';
        });
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const colId = cell.dataset.column;
                const pref = prefs.find(p => p.id === colId);
                cell.style.display = pref && pref.visible ? '' : 'none';
            });
        });
        const table = document.querySelector('table');
        const headerRow = table.querySelector('thead tr');
        const bodyRows = table.querySelectorAll('tbody tr');
        const footerRow = table.querySelector('tfoot tr');
        prefs.forEach(pref => {
            const th = headerRow.querySelector(`th[data-column="${pref.id}"]`);
            if (th) headerRow.appendChild(th);
            bodyRows.forEach(row => {
                const td = row.querySelector(`td[data-column="${pref.id}"]`);
                if (td) row.appendChild(td);
            });
            if (footerRow) {
                const td = footerRow.querySelector(`td[data-column="${pref.id}"]`) || document.createElement('td');
                td.dataset.column = pref.id;
                footerRow.appendChild(td);
            }
        });
    }

    function populateColumnsModal() {
        const sortableList = document.getElementById('sortable-columns');
        sortableList.innerHTML = '';
        let prefs = JSON.parse(localStorage.getItem(COLUMN_PREFS_KEY)) || defaultColumns;
        prefs.forEach(col => {
            const li = document.createElement('li');
            li.className = 'sortable-column';
            li.dataset.id = col.id;
            li.innerHTML = `
                <span>${col.label}</span>
                <input type="checkbox" ${col.visible ? 'checked' : ''} data-id="${col.id}">
            `;
            sortableList.appendChild(li);
        });
        new Sortable(sortableList, { animation: 150, onEnd: updateColumnOrder });
    }

    function updateColumnOrder() {
        const items = document.querySelectorAll('#sortable-columns li');
        const newPrefs = Array.from(items).map(item => {
            const id = item.dataset.id;
            const checkbox = item.querySelector('input');
            return { id, label: defaultColumns.find(col => col.id === id).label, visible: checkbox.checked };
        });
        localStorage.setItem(COLUMN_PREFS_KEY, JSON.stringify(newPrefs));
        applyColumnPrefs(newPrefs);
    }

    customizeColumnsButton.addEventListener('click', function() {
        columnsModal.style.display = 'block';
        populateColumnsModal();
    });

    document.getElementById('save-columns').addEventListener('click', function() {
        updateColumnOrder();
        columnsModal.style.display = 'none';
    });

    document.getElementById('reset-columns').addEventListener('click', function() {
        localStorage.removeItem(COLUMN_PREFS_KEY);
        applyColumnPrefs(defaultColumns);
        columnsModal.style.display = 'none';
        populateColumnsModal();
    });

    document.getElementById('columns-close').addEventListener('click', function() {
        columnsModal.style.display = 'none';
    });

    function loadPresets() {
        try { return JSON.parse(localStorage.getItem(PRESETS_KEY)) || []; } catch (e) { console.error('Invalid presets:', e); return []; }
    }

    function savePreset(name, data, filters, columns, chartPrefs) {
        let presets = loadPresets();
        presets = presets.filter(p => p.name !== name);
        presets.push({ name, data, filters, columns, chartPrefs, timestamp: new Date().toISOString() });
        localStorage.setItem(PRESETS_KEY, JSON.stringify(presets));
        populatePresetsModal();
    }

    function deletePreset(name) {
        let presets = loadPresets();
        presets = presets.filter(p => p.name !== name);
        localStorage.setItem(PRESETS_KEY, JSON.stringify(presets));
        populatePresetsModal();
    }

    function populatePresetsModal() {
        const presetList = document.getElementById('preset-list');
        presetList.innerHTML = '';
        const presets = loadPresets();
        presets.forEach(preset => {
            const li = document.createElement('li');
            li.className = 'p-2 border-b border-[hsl(var(--border))] flex justify-between items-center';
            li.innerHTML = `
                <span class="text-sm text-[hsl(var(--foreground))]">${preset.name} (${new Date(preset.timestamp).toLocaleString()})</span>
                <div class="flex gap-1">
                    <button class="load-preset inline-flex items-center justify-center rounded-md text-xs font-medium h-8 px-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))]" data-name="${preset.name}">{% trans "Load" %}</button>
                    <button class="update-preset inline-flex items-center justify-center rounded-md text-xs font-medium h-8 px-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--accent-foreground))]" data-name="${preset.name}">{% trans "Update" %}</button>
                    <button class="delete-preset inline-flex items-center justify-center rounded-md text-xs font-medium h-8 px-2 bg-[hsl(var(--background))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--destructive))] hover:text-[hsl(var(--destructive-foreground))]" data-name="${preset.name}">{% trans "Delete" %}</button>
                </div>
            `;
            presetList.appendChild(li);
        });
    }

    managePresetsButton.addEventListener('click', function() {
        presetsModal.style.display = 'block';
        populatePresetsModal();
    });

    document.getElementById('save-preset').addEventListener('click', function() {
        const name = document.getElementById('preset-name').value.trim();
        if (!name) { alert('{% trans "Please enter a preset name." %}'); return; }
        const rows = document.querySelectorAll('tbody tr:not(.hidden)');
        const data = Array.from(rows).map(row => {
            const cols = row.querySelectorAll('td');
            return {
                quotation: cols[0].textContent.trim(),
                date: cols[1].textContent.trim(),
                customer: cols[2].querySelector('.font-medium').textContent.trim(),
                sales_employee: cols[3].textContent.trim(),
                total_amount: parseFloat(cols[4].textContent.trim()) || 0,
                status: cols[5].querySelector('span').textContent.trim()
            };
        });
        const formData = new FormData(filterForm);
        const filters = Object.fromEntries(formData);
        const columns = JSON.parse(localStorage.getItem(COLUMN_PREFS_KEY)) || defaultColumns;
        const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
        savePreset(name, data, filters, columns, chartPrefs);
        document.getElementById('preset-name').value = '';
    });

    presetsModal.addEventListener('click', function(e) {
        if (e.target.classList.contains('load-preset')) {
            const name = e.target.dataset.name;
            const preset = loadPresets().find(p => p.name === name);
            if (preset) {
                localStorage.setItem(COLUMN_PREFS_KEY, JSON.stringify(preset.columns));
                localStorage.setItem(CHART_PREFS_KEY, JSON.stringify(preset.chartPrefs || defaultChartPrefs));
                applyColumnPrefs(preset.columns);
                const params = new URLSearchParams(preset.filters).toString();
                window.location.search = params;
            }
            presetsModal.style.display = 'none';
        } else if (e.target.classList.contains('delete-preset')) {
            if (confirm('{% trans "Are you sure you want to delete this preset?" %}')) {
                deletePreset(e.target.dataset.name);
            }
        } else if (e.target.classList.contains('update-preset')) {
            const name = e.target.dataset.name;
            const preset = loadPresets().find(p => p.name === name);
            if (preset) {
                const formData = new FormData(filterForm);
                const filters = Object.fromEntries(formData);
                fetch(`{% url 'Sales:sales_quotation_report' %}?${new URLSearchParams(filters).toString()}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const rows = doc.querySelectorAll('tbody tr:not(.hidden)');
                    const data = Array.from(rows).map(row => {
                        const cols = row.querySelectorAll('td');
                        return {
                            quotation: cols[0].textContent.trim(),
                            date: cols[1].textContent.trim(),
                            customer: cols[2].querySelector('.font-medium').textContent.trim(),
                            sales_employee: cols[3].textContent.trim(),
                            total_amount: parseFloat(cols[4].textContent.trim()) || 0,
                            status: cols[5].querySelector('span').textContent.trim()
                        };
                    });
                    const columns = JSON.parse(localStorage.getItem(COLUMN_PREFS_KEY)) || defaultColumns;
                    const chartPrefs = JSON.parse(localStorage.getItem(CHART_PREFS_KEY)) || defaultChartPrefs;
                    savePreset(name, data, filters, columns, chartPrefs);
                    alert('{% trans "Preset updated successfully!" %}');
                })
                .catch(error => {
                    console.error('Error updating preset:', error);
                    alert('{% trans "Failed to update preset." %}');
                });
            }
        }
    });

    document.getElementById('presets-close').addEventListener('click', function() {
        presetsModal.style.display = 'none';
    });

    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData).toString();
        window.location.search = params;
        if (!chartsSection.classList.contains('hidden')) updateCharts();
    });

    exportPdfButton.addEventListener('click', function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const table = document.querySelector('table');
        html2canvas(table).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            doc.save('sales_quotation_report.pdf');
        });
    });

    exportCsvButton.addEventListener('click', function() {
        const table = document.querySelector('table');
        const rows = table.getElementsByTagName('tr');
        let csvContent = [];
        const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
        csvContent.push(headers.join(','));
        for (let i = 0; i < rows.length - 1; i++) {
            const cols = rows[i].getElementsByTagName('td');
            const rowData = Array.from(cols).map(td => {
                const span = td.querySelector('span');
                return span ? span.textContent.trim() : td.textContent.trim();
            });
            csvContent.push(rowData.join(','));
        }
        const footerRow = table.querySelector('tfoot tr');
        if (footerRow) {
            const footerCols = footerRow.getElementsByTagName('td');
            const footerData = Array.from(footerCols, td => td.textContent.trim().replace('Total:', ''));
            csvContent.push(footerData.join(','));
        }
        const csv = csvContent.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sales_quotation_report.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    pivotTableButton.addEventListener('click', function() {
        pivotModal.style.display = 'block';
        const table = document.querySelector('table');
        const rows = table.querySelectorAll('tbody tr');
        const data = [];
        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length > 0) {
                const dateStr = cols[1].textContent.trim();
                const date = new Date(dateStr);
                const month = date.toLocaleString('default', { month: 'long' });
                const year = date.getFullYear();
                const customerDiv = cols[2].querySelector('div');
                const customerName = customerDiv.querySelector('.font-medium').textContent.trim();
                const totalAmount = parseFloat(cols[4].textContent.trim()) || 0;
                data.push({
                    'Quotation #': cols[0].textContent.trim(),
                    'Date': dateStr,
                    'Month': month,
                    'Year': year,
                    'Customer': customerName,
                    'Sales Employee': cols[3].textContent.trim(),
                    'Total Amount': totalAmount,
                    'Status': cols[5].querySelector('span').textContent.trim()
                });
            }
        });
        if (data.length === 0) {
            document.getElementById('pivot-table-output').innerHTML = '<p class="text-[hsl(var(--muted-foreground))]">{% trans "No data available for pivot table." %}</p>';
            return;
        }
        $(document.getElementById('pivot-table-output')).pivotUI(data, {
            rows: ['Year', 'Month'],
            cols: ['Customer'],
            vals: ['Total Amount'],
            aggregators: { 'Sum of Total Amount': function() { return $.pivotUtilities.aggregatorTemplates.sum()(['Total Amount']); }, 'Count': function() { return $.pivotUtilities.aggregatorTemplates.count()(); } },
            aggregatorName: 'Sum of Total Amount',
            rendererName: 'Table'
        });
    });

    document.getElementById('pivot-close').addEventListener('click', function() {
        pivotModal.style.display = 'none';
        document.getElementById('pivot-table-output').innerHTML = '';
    });

    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            if (event.target.id === 'pivot-modal') {
                document.getElementById('pivot-table-output').innerHTML = '';
            }
        }
    });

    loadColumnPrefs();
    loadChartPrefs();

    tippy('#toggle-charts', { content: '{% trans "Show or hide charts" %}', theme: 'light-border' });
    tippy('#customize-columns', { content: '{% trans "Select and reorder table columns" %}', theme: 'light-border' });
    tippy('#manage-presets', { content: '{% trans "Save, load, or manage report presets" %}', theme: 'light-border' });
    tippy('#export-amount-chart', { content: '{% trans "Export chart as PNG" %}', theme: 'light-border' });
    tippy('#export-status-chart', { content: '{% trans "Export chart as PNG" %}', theme: 'light-border' });
});
</script>
{% endblock %}