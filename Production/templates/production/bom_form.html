{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="mx-auto max-w-8xl px-2 sm:px-4 lg:px-8 py-2 sm:py-6">
    <div class="rounded-xl border-2 border-[hsl(var(--border))] bg-[hsl(var(--background))] shadow-xl p-4 sm:p-8 mb-6 relative">
        <!-- Form Header -->
        <div class="mb-8 border-b border-[hsl(var(--border))] pb-6 relative z-10">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center w-14 h-14 rounded-xl bg-gradient-to-r from-[hsl(var(--primary)/0.8)] to-[hsl(var(--primary)/1.2)] text-[hsl(var(--primary-foreground))] shadow-md premium-icon">
                        <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"></path>
                            <path d="M19.4 15C19.1277 15.8031 19.2583 16.6846 19.75 17.4L19.81 17.49C20.2025 17.8827 20.4111 18.4353 20.3965 19.0054C20.3819 19.5755 20.1452 20.1163 19.73 20.49C19.3148 20.8637 18.7741 21.1004 18.204 21.115C17.6339 21.1296 17.0813 20.921 16.6886 20.5285L16.6 20.47C15.8846 19.9783 15.0031 19.8477 14.2 20.12C13.4101 20.3865 12.7935 21.0031 12.527 21.793L12.5 21.913C12.3724 22.4723 12.0467 22.9654 11.5833 23.3006C11.1199 23.6358 10.5499 23.7947 9.97002 23.7479C9.39016 23.7011 8.8526 23.4519 8.44804 23.0473C8.04348 22.6428 7.79429 22.1052 7.75002 21.5254L7.75002 21.4C7.71821 20.5868 7.32511 19.8372 6.68002 19.34C5.99033 18.8016 5.09577 18.6117 4.25002 18.82C3.68325 18.9861 3.07685 18.9106 2.55811 18.6082C2.03938 18.3057 1.64908 17.8015 1.46002 17.21C1.27478 16.6266 1.30843 15.9926 1.55524 15.4332C1.80205 14.8738 2.24558 14.4303 2.80502 14.1835L2.92502 14.13C3.71416 13.7613 4.29325 13.0844 4.52502 12.27C4.79728 11.4669 4.66672 10.5854 4.17502 9.87L4.11502 9.78C3.72258 9.38734 3.51397 8.83467 3.52858 8.26458C3.54319 7.69449 3.77988 7.15372 4.19502 6.78C4.61017 6.40627 5.15094 6.16959 5.72102 6.15498C6.29111 6.14037 6.84378 6.34897 7.23644 6.74142L7.32502 6.8C8.04044 7.29168 8.92189 7.42224 9.72502 7.15C10.515 6.88347 11.1316 6.26687 11.398 5.47697L11.425 5.357C11.5526 4.79774 11.8783 4.30461 12.3417 3.96941C12.8051 3.6342 13.3751 3.47527 13.955 3.52208C14.5349 3.56889 15.0724 3.81809 15.477 4.22264C15.8815 4.6272 16.1307 5.16476 16.175 5.74462V5.87C16.2068 6.68323 16.5999 7.43277 17.245 7.93C17.9347 8.46843 18.8293 8.65829 19.675 8.45C20.2418 8.28391 20.8482 8.35941 21.3669 8.66185C21.8857 8.96428 22.276 9.46853 22.465 10.06C22.6502 10.6434 22.6166 11.2774 22.3698 11.8368C22.123 12.3962 21.6794 12.8397 21.12 13.0865L20.999 13.14C20.2099 13.5087 19.6308 14.1856 19.399 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold bg-gradient-to-r from-[hsl(var(--primary))] to-[hsl(var(--accent-foreground))] bg-clip-text text-transparent">{{ title }}</h3>
                        <p class="text-xs text-[hsl(var(--muted-foreground))]">{{ subtitle }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    {% if action_buttons %}
                        {% for button in action_buttons %}
                        <a href="{{ button.url }}" class="flex-1 sm:flex-initial inline-flex items-center justify-center gap-2 rounded-lg text-xs font-medium {% if button.class %}{{ button.class }}{% else %}bg-gradient-to-r from-[hsl(var(--primary)/0.8)] to-[hsl(var(--primary)/1.2)] text-[hsl(var(--primary-foreground))]{% endif %} hover:opacity-90 h-9 px-4 py-2 shadow-md transition">
                            {% if button.text == 'Convert to Delivery' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 3.5H16V12H1V3.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 6.5H20L23 9.5V12H16V6.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M5.5 15.5C6.88071 15.5 8 14.3807 8 13C8 11.6193 6.88071 10.5 5.5 10.5C4.11929 10.5 3 11.6193 3 13C3 14.3807 4.11929 15.5 5.5 15.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18.5 15.5C19.8807 15.5 21 14.3807 21 13C21 11.6193 19.8807 10.5 18.5 10.5C17.1193 10.5 16 11.6193 16 13C16 14.3807 17.1193 15.5 18.5 15.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.text == 'Convert to Return' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M17 2L21 6M21 6L17 10M21 6H7C5.93913 6 4.92172 6.42143 4.17157 7.17157C3.42143 7.92172 3 8.93913 3 10C3 11.0609 3.42143 12.0783 4.17157 12.8284C4.92172 13.5786 5.93913 14 7 14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M7 22L3 18M3 18L7 14M3 18H17C18.0609 18 19.0783 17.5786 19.8284 16.8284C20.5786 16.0783 21 15.0609 21 14C21 12.9391 20.5786 11.9217 19.8284 11.1716C19.0783 10.4214 18.0609 10 17 10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.text == 'Convert to Invoice' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.text == 'Convert to Order' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5C15 6.10457 14.1046 7 13 7H11C9.89543 7 9 6.10457 9 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.icon == 'truck' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 3.5H16V12H1V3.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 6.5H20L23 9.5V12H16V6.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M5.5 15.5C6.88071 15.5 8 14.3807 8 13C8 11.6193 6.88071 10.5 5.5 10.5C4.11929 10.5 3 11.6193 3 13C3 14.3807 4.11929 15.5 5.5 15.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18.5 15.5C19.8807 15.5 21 14.3807 21 13C21 11.6193 19.8807 10.5 18.5 10.5C17.1193 10.5 16 11.6193 16 13C16 14.3807 17.1193 15.5 18.5 15.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.icon == 'rotate-ccw' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3.51 15C4.15839 16.8404 5.38734 18.4202 7.01166 19.5014C8.63598 20.5826 10.5677 21.1066 12.5157 20.9945C14.4637 20.8824 16.3226 20.1402 17.8121 18.8798C19.3017 17.6194 20.3413 15.909 20.7742 14.0064C21.2072 12.1037 21.0101 10.1119 20.2126 8.33111C19.4152 6.55033 18.0605 5.0768 16.3528 4.13277C14.6451 3.18874 12.6769 2.82527 10.7447 3.09712C8.81245 3.36897 7.02091 4.26142 5.64 5.64L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.icon == 'file-text' %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% elif button.icon %}
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                    <path d="{{ button.icon_path }}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            {% endif %}
                            <span>{{ button.text }}</span>
                        </a>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="space-y-4" id="bomForm">
            {% csrf_token %}
            
            {% include 'common/toast.html' %}

            <!-- Form Errors Summary -->
            {% include 'common/form-details-error.html' %}

            <!-- Form Fields -->
            <div class="space-y-4">
                <!-- BOM Information -->
                <div class="p-4 border border-[hsl(var(--border))] rounded-lg bg-[hsl(var(--card))] shadow-sm section-collapsible" data-section="bom-info">
                    <h3 class="text-base font-semibold mb-3 flex items-center gap-2 cursor-pointer" onclick="toggleSection('bom-info')">
                        <svg class="w-4 h-4 text-[hsl(var(--primary))] transition-transform duration-300 section-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M9 3H4C3.44772 3 3 3.44772 3 4V9C3 9.55228 3.44772 10 4 10H9C9.55228 10 10 9.55228 10 9V4C10 3.44772 9.55228 3 9 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20 3H15C14.4477 3 14 3.44772 14 4V9C14 9.55228 14.4477 10 15 10H20C20.5523 10 21 9.55228 21 9V4C21 3.44772 20.5523 3 20 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 14H4C3.44772 14 3 14.4477 3 15V20C3 20.5523 3.44772 21 4 21H9C9.55228 21 10 20.5523 10 20V15C10 14.4477 9.55228 14 9 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20 14H15C14.4477 14 14 14.4477 14 15V20C14 20.5523 14.4477 21 15 21H20C20.5523 21 21 20.5523 21 20V15C21 14.4477 20.5523 14 20 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        BOM Information
                        <svg class="w-4 h-4 ml-auto text-[hsl(var(--muted-foreground))] section-toggle-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </h3>
                    <div class="section-content">
                        <!-- BOM Code and Name -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- BOM Code -->
                            <div class="relative">
                                <input type="text" 
                                    id="{{ form.code.id_for_label }}" 
                                    name="{{ form.code.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.code.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] placeholder-transparent" 
                                    placeholder="BOM Code"
                                    value="{{ form.code.value|default:'' }}"
                                    {% if form.code.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}readonly{% endif %}>
                                <label for="{{ form.code.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.code.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    BOM Code {% if form.code.field.required and not is_detail_view %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if form.code.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.code.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- BOM Name -->
                            <div class="relative">
                                <input type="text" 
                                    id="{{ form.name.id_for_label }}" 
                                    name="{{ form.name.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.name.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] placeholder-transparent" 
                                    placeholder="BOM Name"
                                    value="{{ form.name.value|default:'' }}"
                                    {% if form.name.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}readonly{% endif %}>
                                <label for="{{ form.name.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.name.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    BOM Name {% if form.name.field.required and not is_detail_view %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if form.name.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.name.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- BOM Header Fields -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                            <!-- Product -->
                            <div class="relative">
                                <select id="{{ form.product.id_for_label }}" 
                                    name="{{ form.product.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.product.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] appearance-none"
                                    {% if form.product.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}disabled{% endif %}>
                                    <option value="" disabled {% if not form.product.value %}selected{% endif %}>Select Item</option>
                                    {% for choice in form.product.field.choices %}
                                        <option value="{{ choice.0 }}" 
                                            class="py-3 bg-[hsl(var(--background))] text-[hsl(var(--foreground))] hover:bg-[hsl(var(--primary))] hover:text-[hsl(var(--primary-foreground))]"
                                            {% if form.product.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.product.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.product.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    Product {% if form.product.field.required and not is_detail_view %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if not is_detail_view %}
                                <svg class="absolute right-3 top-3.5 w-5 h-5 pointer-events-none text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                {% endif %}
                                {% if form.product.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.product.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- BOM Type -->
                            <div class="relative">
                                <select id="{{ form.bom_type.id_for_label }}" 
                                    name="{{ form.bom_type.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.bom_type.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] appearance-none"
                                    {% if form.bom_type.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}disabled{% endif %}>
                                    {% for choice in form.bom_type.field.choices %}
                                        <option value="{{ choice.0 }}" 
                                            class="py-3 bg-[hsl(var(--background))] text-[hsl(var(--foreground))] hover:bg-[hsl(var(--primary))] hover:text-[hsl(var(--primary-foreground))]"
                                            {% if form.bom_type.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.bom_type.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.bom_type.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    BOM Type
                                </label>
                                {% if not is_detail_view %}
                                <svg class="absolute right-3 top-3.5 w-5 h-5 pointer-events-none text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                {% endif %}
                                {% if form.bom_type.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.bom_type.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- UoM -->
                            <div class="relative">
                                <select id="{{ form.uom.id_for_label }}" 
                                    name="{{ form.uom.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.uom.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] appearance-none"
                                    {% if form.uom.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}disabled{% endif %}>
                                    <option value="" disabled {% if not form.uom.value %}selected{% endif %}></option>
                                    {% for choice in form.uom.field.choices %}
                                        <option value="{{ choice.0 }}" 
                                            class="py-3 bg-[hsl(var(--background))] text-[hsl(var(--foreground))] hover:bg-[hsl(var(--primary))] hover:text-[hsl(var(--primary-foreground))]"
                                            {% if form.uom.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.uom.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.uom.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    UoM {% if form.uom.field.required and not is_detail_view %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if not is_detail_view %}
                                <svg class="absolute right-3 top-3.5 w-5 h-5 pointer-events-none text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                {% endif %}
                                {% if form.uom.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.uom.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- X Quantity -->
                            <div class="relative">
                                <input type="number" 
                                    id="{{ form.x_quantity.id_for_label }}" 
                                    name="{{ form.x_quantity.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.x_quantity.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] placeholder-transparent" 
                                    placeholder="X Quantity"
                                    value="{{ form.x_quantity.value|default:'1' }}"
                                    min="0.000001" step="0.000001"
                                    {% if form.x_quantity.field.required and not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}readonly{% endif %}>
                                <label for="{{ form.x_quantity.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.x_quantity.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    X Quantity
                                </label>
                                {% if form.x_quantity.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.x_quantity.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Status -->
                            <div class="relative">
                                <select id="{{ form.status.id_for_label }}" 
                                    name="{{ form.status.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 {% if form.status.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] appearance-none"
                                    {% if not is_detail_view %}required{% endif %}
                                    {% if is_detail_view %}disabled{% endif %}>
                                    <option value="" disabled {% if not form.status.value %}selected{% endif %}>Select Status</option>
                                    {% for choice in form.status.field.choices %}
                                        <option value="{{ choice.0 }}" 
                                            class="py-3 bg-[hsl(var(--background))] text-[hsl(var(--foreground))] hover:bg-[hsl(var(--primary))] hover:text-[hsl(var(--primary-foreground))]"
                                            {% if form.status.value|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.status.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.status.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    Status {% if not is_detail_view %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if not is_detail_view %}
                                <svg class="absolute right-3 top-3.5 w-5 h-5 pointer-events-none text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                {% endif %}
                                {% if form.status.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.status.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Project Field -->
                        <div class="relative mb-4">
                            <input type="text" 
                                id="{{ form.project.id_for_label }}" 
                                name="{{ form.project.name }}"
                                class="peer w-full px-3 py-2 rounded-md border-2 {% if form.project.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] placeholder-transparent" 
                                placeholder="Project"
                                value="{{ form.project.value|default:'Project 01' }}"
                                {% if form.project.field.required and not is_detail_view %}required{% endif %}
                                {% if is_detail_view %}readonly{% endif %}>
                            <label for="{{ form.project.id_for_label }}" 
                                class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] {% if form.project.errors %}text-red-500{% else %}text-[hsl(var(--muted-foreground))]{% endif %} peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                Project
                            </label>
                            {% if form.project.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in form.project.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Component Information -->
                <div class="p-4 border border-[hsl(var(--border))] rounded-lg bg-[hsl(var(--card))] shadow-sm section-collapsible" data-section="component-info">
                    <h3 class="text-base font-semibold mb-3 flex items-center gap-2 cursor-pointer" onclick="toggleSection('component-info')">
                        <svg class="w-4 h-4 text-[hsl(var(--primary))] transition-transform duration-300 section-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M16 3H8C6.89543 3 6 3.89543 6 5V19C6 20.1046 6 21 8 21H16C17.1046 21 18 20.1046 18 19V5C18 3.89543 17.1046 3 16 3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 18H12.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Component Information
                        <svg class="w-4 h-4 ml-auto text-[hsl(var(--muted-foreground))] section-toggle-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </h3>
                    <div class="section-content">
                        <!-- Formset Management Form -->
                        {{ formset.management_form }}

                        <!-- Mobile Display View -->
                        <div class="md:hidden space-y-3" id="mobileFormsetContainer">
                            {% for form in formset.forms %}
                            <div class="mobile-formset-row p-3 border border-[hsl(var(--border))] rounded-lg relative transition-all duration-300 hover:shadow-md hover:border-[hsl(var(--primary))] draggable" data-index="{{ forloop.counter0 }}" draggable="true">
                                <button type="button" class="mobile-context-btn absolute top-2 right-2 w-6 h-6 rounded-full bg-[hsl(var(--muted))] flex items-center justify-center hover:bg-[hsl(var(--primary))] hover:text-[hsl(var(--primary-foreground))] transition-colors">
                                    <svg class="w-4 h-4 text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 5V5.01M12 12V12.01M12 19V19.01M12 6C11.4477 6 11 5.55228 11 5C11 4.44772 11.4477 4 12 4C12.5523 4 13 4.44772 13 5C13 5.55228 12.5523 6 12 6ZM12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 12.4477 13 12C13 12.5523 12.5523 13 12 13ZM12 20C11.4477 20 11 19.5523 11 19C11 18.4477 11.4477 18 12 18C12.5523 18 13 18.4477 13 19C13 19.5523 12.5523 20 12 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <div class="space-y-2">
                                    <!-- Hidden Fields -->
                                    {% if form.id %}
                                    <input type="hidden" name="{{ form.id.id_for_label }}" value="{{ form.id.value|default:'' }}" id="{{ form.id.id_for_label }}" />
                                    {% endif %}
                                    <!-- Item Code and Name -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="item-input-wrapper relative">
                                            <label class="text-xs font-medium mb-1 block">Item Code</label>
                                            <input type="text" name="{{ form.item_code.html_name }}" value="{{ form.item_code.value|default:'' }}"
                                                class="w-full px-2 py-1 text-sm border rounded-md bg-[hsl(var(--muted))] item-code-input transition-all duration-200 focus:ring-1 focus:ring-[hsl(var(--primary))]"
                                                id="{{ form.item_code.id_for_label }}" />
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium mb-1 block">Item Name</label>
                                            <input type="text" name="{{ form.item_name.html_name }}" value="{{ form.item_name.value|default:'' }}"
                                                class="w-full px-2 py-1 text-sm border rounded-md bg-[hsl(var(--background))] item-name-input transition-all duration-200 focus:ring-1 focus:ring-[hsl(var(--primary))]"
                                                id="{{ form.item_name.id_for_label }}" />
                                        </div>
                                    </div>
                                    <!-- Quantity and Price -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs font-medium mb-1 block">Quantity</label>
                                            <input type="number" name="{{ form.quantity.html_name }}" value="{{ form.quantity.value|default:'1' }}"
                                                min="1" step="0.000001"
                                                class="w-full px-2 py-1 text-sm border rounded-md bg-[hsl(var(--background))] quantity-input transition-all duration-200 focus:ring-1 focus:ring-[hsl(var(--primary))]"
                                                id="{{ form.quantity.id_for_label }}" />
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium mb-1 block">Unit Price</label>
                                            <input type="number" name="{{ form.unit_price.html_name }}" value="{{ form.unit_price.value|default:'0.00' }}"
                                                min="0" step="0.000001"
                                                class="w-full px-2 py-1 text-sm border rounded-md bg-[hsl(var(--background))] unit-price-input transition-all duration-200 focus:ring-1 focus:ring-[hsl(var(--primary))]"
                                                id="{{ form.unit_price.id_for_label }}" />
                                        </div>
                                    </div>
                                    <!-- Unit of Measure -->
                                    <div>
                                        <label class="text-xs font-medium mb-1 block">UOM</label>
                                        <input type="text" name="{{ form.uom.html_name }}" value="{{ form.uom.value|default:'' }}"
                                            class="w-full px-2 py-1 text-sm border rounded-md bg-[hsl(var(--background))] uom-input transition-all duration-200 focus:ring-1 focus:ring-[hsl(var(--primary))]"
                                            id="{{ form.uom.id_for_label }}" />
                                    </div>
                                    <!-- Delete Button -->
                                    <div class="flex justify-end mt-2">
                                        <button type="button" class="delete-row mobile-delete-row inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 hover:text-red-700 relative group" data-tooltip="Delete this component">
                                            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Delete
                                            <span class="tooltip-text absolute bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--destructive-foreground))] bg-[hsl(var(--destructive))] px-2 py-1 rounded-md shadow-md">Delete this component</span>
                                        </button>
                                        {% if form.DELETE %}
                                        <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" class="delete-checkbox hidden">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Mobile Context Menu -->
                        <div id="mobileContextMenu" class="hidden fixed z-[100] w-40 sm:w-48 bg-[hsl(var(--background))] rounded-md shadow-lg border border-[hsl(var(--border))] overflow-hidden">
                            <div class="py-1">
                                <button type="button" class="w-full text-left px-3 sm:px-4 py-2 text-xs sm:text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="mobileAddRowAboveBtn" data-tooltip="Add a new row above">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Add Row Above
                                    <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--foreground))] bg-[hsl(var(--accent))] px-2 py-1 rounded-md shadow-md">Add a new row above</span>
                                </button>
                                <button type="button" class="w-full text-left px-3 sm:px-4 py-2 text-xs sm:text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="mobileAddRowBelowBtn" data-tooltip="Add a new row below">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Add Row Below
                                    <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--foreground))] bg-[hsl(var(--accent))] px-2 py-1 rounded-md shadow-md">Add a new row below</span>
                                </button>
                                <button type="button" class="w-full text-left px-3 sm:px-4 py-2 text-xs sm:text-sm text-[hsl(var(--destructive))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="mobileDeleteRowBtn" data-tooltip="Delete this row">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                        <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Delete Row
                                    <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--destructive-foreground))] bg-[hsl(var(--destructive))] px-2 py-1 rounded-md shadow-md">Delete this row</span>
                                </button>
                            </div>
                        </div>

                        <!-- Desktop Display View -->
                        <div class="hidden md:block">
                            <div class="overflow-x-auto overflow-y-auto max-h-[250px] sm:max-h-[350px] md:max-h-[400px] rounded-lg border border-[hsl(var(--border))] shadow-inner">
                                <div class="min-w-[800px]">
                                    <table class="w-full">
                                        <thead class="w-full border-collapse">
                                            <tr>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">Item Code</th>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">Item Name</th>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">Quantity</th>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">Unit Price</th>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">UOM</th>
                                                <th scope="col" class="py-3 px-4 text-center text-xs font-semibold uppercase tracking-wider text-[hsl(var(--secondary-foreground))]">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="formsetBody" class="formset-container divide-y divide-[hsl(var(--border))]">
                                            {% for form in formset.forms %}
                                            <tr class="formset-row group hover:bg-[hsl(var(--accent))] transition-all duration-300 draggable {% if form.errors %}has-errors{% endif %}" data-index="{{ forloop.counter0 }}" draggable="true">
                                                <!-- Hidden Fields -->
                                                {% if form.id %}
                                                <input type="hidden" name="{{ form.id.html_name }}" value="{{ form.id.value|default:'' }}" id="{{ form.id.id_for_label }}">
                                                {% endif %}
                                                <td class="py-2 px-4">
                                                    <div class="item-input-wrapper relative">
                                                        <input type="text" name="{{ form.item_code.html_name }}" value="{{ form.item_code.value|default:'' }}"
                                                            class="w-full px-3 py-1 text-sm border {% if form.item_code.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--background))] premium-input text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--ring))] item-code-input transition-all duration-200"
                                                            id="{{ form.item_code.id_for_label }}">
                                                        {% if form.item_code.errors %}
                                                        <div class="text-red-500 text-xs mt-1">
                                                            {% for error in form.item_code.errors %}
                                                            <p>{{ error }}</p>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="py-2 px-4">
                                                    <input type="text" name="{{ form.item_name.html_name }}" value="{{ form.item_name.value|default:'' }}"
                                                        class="w-full px-3 py-1 text-sm border {% if form.item_name.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--background))] premium-input text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--ring))] item-name-input transition-all duration-200"
                                                        id="{{ form.item_name.id_for_label }}">
                                                    {% if form.item_name.errors %}
                                                    <div class="text-red-500 text-xs mt-1">
                                                        {% for error in form.item_name.errors %}
                                                        <p>{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td class="py-2 px-4">
                                                    <input type="number" name="{{ form.quantity.html_name }}" value="{{ form.quantity.value|default:'1' }}" min="0" step="0.000001"
                                                        class="w-full px-3 py-1 text-sm border {% if form.quantity.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--background))] premium-input text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--ring))] quantity-input transition-all duration-200"
                                                        id="{{ form.quantity.id_for_label }}">
                                                    {% if form.quantity.errors %}
                                                    <div class="text-red-500 text-xs mt-1">
                                                        {% for error in form.quantity.errors %}
                                                        <p>{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td class="py-2 px-4">
                                                    <input type="number" name="{{ form.unit_price.html_name }}" value="{{ form.unit_price.value|default:'0.00' }}" min="0" step="0.000001"
                                                        class="w-full px-3 py-1 text-sm border {% if form.unit_price.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--background))] premium-input text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--ring))] unit-price-input transition-all duration-200"
                                                        id="{{ form.unit_price.id_for_label }}">
                                                    {% if form.unit_price.errors %}
                                                    <div class="text-red-500 text-xs mt-1">
                                                        {% for error in form.unit_price.errors %}
                                                        <p>{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td class="py-2 px-4">
                                                    <input type="text" name="{{ form.uom.html_name }}" value="{{ form.uom.value|default:'' }}"
                                                        class="w-full px-3 py-1 text-sm border {% if form.uom.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--background))] premium-input text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--ring))] uom-input transition-all duration-200"
                                                        id="{{ form.uom.id_for_label }}">
                                                    {% if form.uom.errors %}
                                                    <div class="text-red-500 text-xs mt-1">
                                                        {% for error in form.uom.errors %}
                                                        <p>{{ error }}</p>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td class="py-2 px-4 relative">
                                                    <button type="button" class="delete-row desktop-delete-row opacity-0 group-hover:opacity-100 transition-opacity duration-150 inline-flex items-center justify-center rounded-full w-8 h-8 bg-[hsl(var(--destructive))] text-[hsl(var(--destructive-foreground))] hover:bg-[hsl(var(--destructive))/90] shadow-md relative group" data-tooltip="Delete this component">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                        <span class="tooltip-text absolute bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--destructive-foreground))] bg-[hsl(var(--destructive))] px-2 py-1 rounded-md shadow-md">Delete this component</span>
                                                    </button>
                                                    {% if form.DELETE %}
                                                    <input type="checkbox" name="{{ form.DELETE.html_name }}" id="{{ form.DELETE.id_for_label }}" class="delete-checkbox hidden">
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if form.non_field_errors %}
                                            <tr class="error-row bg-red-50">
                                                <td colspan="6" class="py-1 px-2 text-xs text-red-600">
                                                    <div class="flex items-center">
                                                        <svg class="w-4 h-4 mr-1 text-red-500" viewBox="0 0 24 24" fill="none">
                                                            <path d="M12 9V13M12 17H12.01M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                        {% for error in form.non_field_errors %}
                                                        <span>{{ error }}</span>{% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Context Menu -->
                            <div id="contextMenu" class="hidden fixed z-[100] w-48 bg-[hsl(var(--background))] rounded-md shadow-lg border border-[hsl(var(--border))] overflow-hidden">
                                <div class="py-1">
                                    <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="addRowAboveBtn" data-tooltip="Add a new row above">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Add Row Above
                                        <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--foreground))] bg-[hsl(var(--accent))] px-2 py-1 rounded-md shadow-md">Add a new row above</span>
                                    </button>
                                    <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="addRowBelowBtn" data-tooltip="Add a new row below">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Add Row Below
                                        <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--foreground))] bg-[hsl(var(--accent))] px-2 py-1 rounded-md shadow-md">Add a new row below</span>
                                    </button>
                                    <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--destructive))] hover:bg-[hsl(var(--accent))] transition-colors flex items-center gap-2 relative group" id="deleteRowBtn" data-tooltip="Delete this row">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                            <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Delete Row
                                        <span class="tooltip-text absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block text-xs text-[hsl(var(--destructive-foreground))] bg-[hsl(var(--destructive))] px-2 py-1 rounded-md shadow-md">Delete this row</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Add Row Button -->
                        <button type="button" id="addRowBtn" class="w-full mt-3 px-4 py-2 rounded-lg text-xs font-medium bg-gradient-to-r from-[hsl(var(--primary)/0.8)] to-[hsl(var(--primary)/1.2)] text-[hsl(var(--primary-foreground))] hover:opacity-90 shadow-md flex items-center justify-center gap-2 relative group">
                            <svg class="w-4 h-4 button-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="button-text">Add New Component</span>
                            <svg class="w-4 h-4 button-spinner hidden animate-spin" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" fill="currentColor" opacity="0.3"/>
                                <path d="M12 2a10 10 0 0 1 10 10h-2a8 8 0 0 0-8-8z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Summary Fields -->
                <div class="p-4 border border-[hsl(var(--border))] rounded-lg bg-[hsl(var(--card))] shadow-sm section-collapsible" data-section="summary">
                    <h3 class="text-base font-semibold mb-3 flex items-center gap-2 cursor-pointer" onclick="toggleSection('summary')">
                        <svg class="w-4 h-4 text-[hsl(var(--primary))] transition-transform duration-300 section-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 1V23M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Summary
                        <svg class="w-4 h-4 ml-auto text-[hsl(var(--muted-foreground))] section-toggle-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </h3>
                    <div class="section-content">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Total Component Value -->
                            <div class="relative">
                                <input type="number" 
                                    id="{{ form.total_component_value.id_for_label }}" 
                                    name="{{ form.total_component_value.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-[hsl(var(--muted))] premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] placeholder-transparent cursor-not-allowed" 
                                    placeholder="Total Component Value"
                                    value="{{ form.total_component_value.value|default:'0.00' }}"
                                    readonly>
                                <label for="{{ form.total_component_value.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    Total Component Value
                                </label>
                                {% if form.total_component_value.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.total_component_value.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Other Cost % -->
                            <div class="relative">
                                <input type="number" 
                                    id="{{ form.other_cost_percentage.id_for_label }}" 
                                    name="{{ form.other_cost_percentage.name }}"
                                    class="peer w-full px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-transparent{% endif %} premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] focus:bg-[hsl(var(--accent))] placeholder-transparent" 
                                    placeholder="Other Cost %"
                                    value="{{ form.other_cost_percentage.value|default:'0.00' }}"
                                    min="0" max="100" step="0.01"
                                    {% if is_detail_view %}readonly{% endif %}>
                                <label for="{{ form.other_cost_percentage.id_for_label }}" 
                                    class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                    Other Cost %
                                </label>
                                {% if form.other_cost_percentage.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.other_cost_percentage.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                     
                        <!-- Additional Cost -->
                        <div class="relative">
                            <input type="number" 
                                id="{{ form.additional_cost.id_for_label }}" 
                                name="{{ form.additional_cost.name }}"
                                class="peer w-full px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-[hsl(var(--muted))] premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] placeholder-transparent cursor-not-allowed" 
                                placeholder="Additional Cost"
                                value="{{ form.additional_cost.value|default:'0.00' }}"
                                readonly>
                            <label for="{{ form.additional_cost.id_for_label }}" 
                                class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                Additional Cost
                            </label>
                            {% if form.additional_cost.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in form.additional_cost.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Total After Discount -->
                        <div class="relative">
                            <input type="number" 
                                id="{{ form.total_after_discount.id_for_label }}" 
                                name="{{ form.total_after_discount.name }}"
                                class="peer w-full px-3 py-2 rounded-md border-2 border-[hsl(var(--border))] bg-[hsl(var(--muted))] premium-input text-[hsl(var(--foreground))] transition-all duration-200 focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] placeholder-transparent cursor-not-allowed" 
                                placeholder="Total After Discount"
                                value="{{ form.total_after_discount.value|default:'0.00' }}"
                                readonly>
                            <label for="{{ form.total_after_discount.id_for_label }}" 
                                class="absolute left-3 -top-2.5 px-1 text-sm transition-all duration-300 bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-[hsl(var(--primary))] peer-placeholder-shown:top-3 peer-placeholder-shown:text-base">
                                Total After Discount
                            </label>
                            {% if form.total_after_discount.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in form.total_after_discount.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            <!-- Form Footer -->
            <div class="border-t pt-4 flex flex-col sm:flex-row justify-between items-center gap-3">
                <div class="text-xs text-[hsl(var(--muted-foreground))]">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z" fill="currentColor"/>
                        </svg>
                        Your BOM is secure and encrypted
                    </span>
                </div>
            <div class="flex gap-3 w-full sm:w-auto">
                    {% if cancel_url %}
                    <a href="{{ cancel_url }}" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-xs font-medium bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))] hover:opacity-90 h-9 px-4 py-2 shadow-md">
                        {% if is_detail_view %}Back{% else %}Cancel{% endif %}
                    </a>
                    {% endif %}
                    
                    {% if is_detail_view %}
                        {% if update_url %}
                        <a href="{{ update_url }}" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-xs font-medium bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))] hover:opacity-90 h-9 px-4 py-2 shadow-md">
                            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                                <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Edit
                        </a>
                        {% endif %}
                        {% if delete_url %}
                        <a href="{{ delete_url }}" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-xs font-medium bg-red-100 text-red-700 hover:bg-red-200 h-9 px-4 py-2 shadow-md">
                            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Delete
                        </a>
                        {% endif %}
                    {% else %}
                        <button type="reset" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-xs font-medium bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))] hover:opacity-90 h-9 px-4 py-2 shadow-md">
                            Reset
                        </button>
                        <button type="submit" id="submitBtn" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-xs font-medium bg-gradient-to-r from-[hsl(var(--primary)/0.8)] to-[hsl(var(--primary)/1.2)] text-[hsl(var(--primary-foreground))] hover:opacity-90 h-9 px-4   to-[hsl(var(--primary)/1.2)] text-[hsl(var(--primary-foreground))] hover:opacity-90 h-9 px-4 py-2 shadow-md">
                            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                                <path d="M5 12L10 17L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            {% if submit_text %}{{ submit_text }}{% else %}Submit{% endif %}
                        </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get references to the form elements
    const mobileContainer = document.getElementById('mobileFormsetContainer');
    const desktopBody = document.getElementById('formsetBody');
    const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
    const addRowBtn = document.getElementById('addRowBtn');
    const contextMenu = document.getElementById('contextMenu');
    const mobileContextMenu = document.getElementById('mobileContextMenu');

    let currentRow = null;
    let currentMobileRow = null;

    // Add Row button
    addRowBtn.addEventListener('click', function() {
        addNewRow();
    });

    // Function to add a new row
    function addNewRow(position = null, referenceIndex = null) {
        // Get the template from the first row
        let template;

        // Try to get template from desktop view first
        if (desktopBody && desktopBody.querySelector('.formset-row')) {
            template = desktopBody.querySelector('.formset-row').cloneNode(true);
        } 
        // If no desktop template, try mobile view
        else if (mobileContainer && mobileContainer.querySelector('.mobile-formset-row')) {
            template = mobileContainer.querySelector('.mobile-formset-row').cloneNode(true);
        }

        if (!template) {
            console.error("Could not find template row");
            return;
        }

        // Get current form count
        const currentFormCount = parseInt(totalForms.value);
        const newIndex = currentFormCount;

        // Update form indices
        template.querySelectorAll('input').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/-\d+-/, `-${newIndex}-`);
            }
            if (input.id) {
                input.id = input.id.replace(/-\d+-/, `-${newIndex}-`);
            }

            // Clear values except for hidden fields
            if (input.type !== 'hidden' && !input.classList.contains('delete-checkbox')) {
                input.value = '';
            }
        });

        // Reset DELETE checkbox
        const deleteCheckbox = template.querySelector('.delete-checkbox');
        if (deleteCheckbox) {
            deleteCheckbox.checked = false;
        }

        // Update data-index attribute
        template.dataset.index = newIndex;

        // Insert at the specified position in desktop view
        if (desktopBody) {
            if (position === 'above' && referenceIndex !== null) {
                const referenceRow = desktopBody.querySelector(`.formset-row[data-index="${referenceIndex}"]`);
                if (referenceRow) {
                    desktopBody.insertBefore(template, referenceRow);
                } else {
                    desktopBody.appendChild(template);
                }
            } else if (position === 'below' && referenceIndex !== null) {
                const referenceRow = desktopBody.querySelector(`.formset-row[data-index="${referenceIndex}"]`);
                if (referenceRow && referenceRow.nextSibling) {
                    desktopBody.insertBefore(template, referenceRow.nextSibling);
                } else {
                    desktopBody.appendChild(template);
                }
            } else {
                desktopBody.appendChild(template);
            }
        }

        // Also add to mobile view
        if (mobileContainer) {
            // Clone the mobile template
            let mobileTemplate;
            if (mobileContainer.querySelector('.mobile-formset-row')) {
                mobileTemplate = mobileContainer.querySelector('.mobile-formset-row').cloneNode(true);

                // Update form indices
                mobileTemplate.querySelectorAll('input').forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/-\d+-/, `-${newIndex}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(/-\d+-/, `-${newIndex}-`);
                    }

                    // Clear values except for hidden fields
                    if (input.type !== 'hidden' && !input.classList.contains('delete-checkbox')) {
                        input.value = '';
                    }
                });

                // Reset DELETE checkbox
                const mobileDeleteCheckbox = mobileTemplate.querySelector('.delete-checkbox');
                if (mobileDeleteCheckbox) {
                    mobileDeleteCheckbox.checked = false;
                }

                // Update data-index attribute
                mobileTemplate.dataset.index = newIndex;

                // Insert at the specified position in mobile view
                if (position === 'above' && referenceIndex !== null) {
                    const referenceRow = mobileContainer.querySelector(`.mobile-formset-row[data-index="${referenceIndex}"]`);
                    if (referenceRow) {
                        mobileContainer.insertBefore(mobileTemplate, referenceRow);
                    } else {
                        mobileContainer.appendChild(mobileTemplate);
                    }
                } else if (position === 'below' && referenceIndex !== null) {
                    const referenceRow = mobileContainer.querySelector(`.mobile-formset-row[data-index="${referenceIndex}"]`);
                    if (referenceRow && referenceRow.nextSibling) {
                        mobileContainer.insertBefore(mobileTemplate, referenceRow.nextSibling);
                    } else {
                        mobileContainer.appendChild(mobileTemplate);
                    }
                } else {
                    mobileContainer.appendChild(mobileTemplate);
                }
            }
        }

        // Update the form count
        totalForms.value = currentFormCount + 1;

        // Initialize the new row with event handlers
        setupRowEventHandlers();
    }

    // Setup event handlers for rows
    function setupRowEventHandlers() {
        // Setup delete buttons
        document.querySelectorAll('.delete-row').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('.formset-row, .mobile-formset-row');
                if (row) {
                    const index = row.dataset.index;
                    const deleteCheckbox = row.querySelector('.delete-checkbox');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        row.style.display = 'none';

                        // Also hide the corresponding row in the other view
                        if (row.classList.contains('formset-row') && mobileContainer) {
                            const mobileRow = mobileContainer.querySelector(`.mobile-formset-row[data-index="${index}"]`);
                            if (mobileRow) {
                                mobileRow.style.display = 'none';
                            }
                        } else if (row.classList.contains('mobile-formset-row') && desktopBody) {
                            const desktopRow = desktopBody.querySelector(`.formset-row[data-index="${index}"]`);
                            if (desktopRow) {
                                desktopRow.style.display = 'none';
                            }
                        }
                    }
                }
            });
        });

        // Setup context menu for desktop rows
        if (desktopBody) {
            desktopBody.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const row = e.target.closest('.formset-row');
                if (row) {
                    currentRow = row;

                    // Position and show context menu
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.style.display = 'block';
                }
            });
        }

        // Setup context menu buttons for mobile rows
        document.querySelectorAll('.mobile-context-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const mobileRow = this.closest('.mobile-formset-row');
                if (mobileRow) {
                    currentMobileRow = mobileRow;

                    // Position and show mobile context menu
                    const rect = this.getBoundingClientRect();
                    mobileContextMenu.style.left = `${rect.left}px`;
                    mobileContextMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
                    mobileContextMenu.style.display = 'block';
                }
            });
        });
    }

    // Desktop context menu actions
    document.getElementById('addRowAboveBtn').addEventListener('click', function() {
        if (currentRow) {
            const index = currentRow.dataset.index;
            addNewRow('above', index);
            contextMenu.style.display = 'none';
        }
    });

    document.getElementById('addRowBelowBtn').addEventListener('click', function() {
        if (currentRow) {
            const index = currentRow.dataset.index;
            addNewRow('below', index);
            contextMenu.style.display = 'none';
        }
    });

    document.getElementById('deleteRowBtn').addEventListener('click', function() {
        if (currentRow) {
            const deleteButton = currentRow.querySelector('.delete-row');
            if (deleteButton) {
                deleteButton.click();
            }
            contextMenu.style.display = 'none';
        }
    });

    // Mobile context menu actions
    document.getElementById('mobileAddRowAboveBtn').addEventListener('click', function() {
        if (currentMobileRow) {
            const index = currentMobileRow.dataset.index;
            addNewRow('above', index);
            mobileContextMenu.style.display = 'none';
        }
    });

    document.getElementById('mobileAddRowBelowBtn').addEventListener('click', function() {
        if (currentMobileRow) {
            const index = currentMobileRow.dataset.index;
            addNewRow('below', index);
            mobileContextMenu.style.display = 'none';
        }
    });

    document.getElementById('mobileDeleteRowBtn').addEventListener('click', function() {
        if (currentMobileRow) {
            const deleteButton = currentMobileRow.querySelector('.delete-row');
            if (deleteButton) {
                deleteButton.click();
            }
            mobileContextMenu.style.display = 'none';
        }
    });

    // Hide context menus on click outside
    document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
        }
        if (!mobileContextMenu.contains(e.target)) {
            mobileContextMenu.style.display = 'none';
        }
    });

    // Hide context menus on scroll
    document.addEventListener('scroll', function() {
        contextMenu.style.display = 'none';
        mobileContextMenu.style.display = 'none';
    });

    // Initialize existing rows
    setupRowEventHandlers();
});
</script>
<script src="{% static 'js/formset-cleanup.js' %}"></script>
<script src="{% static 'js/item-autocomplete.js' %}"></script>
<script src="{% static 'js/item-search-modal-optimized.js' %}"></script>
<script src="{% static 'js/mobile-item-autocomplete.js' %}"></script>
<script src="{% static 'js/collapse.js' %}"></script>
<script src="{% static 'js/select-search.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    makeSelectSearchable('product');
    makeSelectSearchable('bom_type');
    makeSelectSearchable('uom');
});
</script>
{% endblock extra_js %}
