{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="rounded-xl border border-[hsl(var(--border))] bg-[hsl(var(--background))] shadow-lg p-6 sm:p-8 mb-6">
        <!-- Form Header -->
        <div class="mb-6 border-b border-[hsl(var(--border))] pb-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-r from-[hsl(var(--primary))] to-[hsl(var(--accent))] text-[hsl(var(--primary-foreground))] shadow-md">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"></path>
                            <path d="M19.4 15C19.1277 15.8031 19.2583 16.6846 19.75 17.4L19.81 17.49C20.2025 17.8827 20.4111 18.4353 20.3965 19.0054C20.3819 19.5755 20.1452 20.1163 19.73 20.49C19.3148 20.8637 18.7741 21.1004 18.204 21.115C17.6339 21.1296 17.0813 20.921 16.6886 20.5285L16.6 20.47C15.8846 19.9783 15.0031 19.8477 14.2 20.12C13.4101 20.3865 12.7935 21.0031 12.527 21.793L12.5 21.913C12.3724 22.4723 12.0467 22.9654 11.5833 23.3006C11.1199 23.6358 10.5499 23.7947 9.97002 23.7479C9.39016 23.7011 8.8526 23.4519 8.44804 23.0473C8.04348 22.6428 7.79429 22.1052 7.75002 21.5254L7.75002 21.4C7.71821 20.5868 7.32511 19.8372 6.68002 19.34C5.99033 18.8016 5.09577 18.6117 4.25002 18.82C3.68325 18.9861 3.07685 18.9106 2.55811 18.6082C2.03938 18.3057 1.64908 17.8015 1.46002 17.21C1.27478 16.6266 1.30843 15.9926 1.55524 15.4332C1.80205 14.8738 2.24558 14.4303 2.80502 14.1835L2.92502 14.13C3.71416 13.7613 4.29325 13.0844 4.52502 12.27C4.79728 11.4669 4.66672 10.5854 4.17502 9.87L4.11502 9.78C3.72258 9.38734 3.51397 8.83467 3.52858 8.26458C3.54319 7.69449 3.77988 7.15372 4.19502 6.78C4.61017 6.40627 5.15094 6.16959 5.72102 6.15498C6.29111 6.14037 6.84378 6.34897 7.23644 6.74142L7.32502 6.8C8.04044 7.29168 8.92189 7.42224 9.72502 7.15C10.515 6.88347 11.1316 6.26687 11.398 5.47697L11.425 5.357C11.5526 4.79774 11.8783 4.30461 12.3417 3.96941C12.8051 3.6342 13.3751 3.47527 13.955 3.52208C14.5349 3.56889 15.0724 3.81809 15.477 4.22264C15.8815 4.6272 16.1307 5.16476 16.175 5.74462V5.87C16.2068 6.68323 16.5999 7.43277 17.245 7.93C17.9347 8.46843 18.8293 8.65829 19.675 8.45C20.2418 8.28391 20.8482 8.35941 21.3669 8.66185C21.8857 8.96428 22.276 9.46853 22.465 10.06C22.6502 10.6434 22.6166 11.2774 22.3698 11.8368C22.123 12.3962 21.6794 12.8397 21.12 13.0865L20.999 13.14C20.2099 13.5087 19.6308 14.1856 19.399 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold bg-gradient-to-r from-[hsl(var(--primary))] to-[hsl(var(--accent))] bg-clip-text text-transparent">{{ title }}</h3>
                        <p class="text-sm text-[hsl(var(--muted-foreground))]">{{ subtitle }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    {% for button in action_buttons %}
                    <a href="{{ button.url }}" class="inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium {{ button.class }} hover:opacity-90 h-10 px-4 py-2 shadow-md transition">
                        {% if button.text == 'Edit' %}
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18.5 2.5C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.5C21.8978 2.89784 22.1213 3.4374 22.1213 4C22.1213 4.56262 21.8978 5.10219 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% elif button.text == 'Delete' %}
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% endif %}
                        <span>{{ button.text }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="space-y-6" id="bomForm">
            {% csrf_token %}
            
            {% include 'common/toast.html' %}

            <!-- Form Errors Summary -->
            {% if form.errors or formset.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-center text-red-600">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none">
                        <path d="M12 9V13M12 17H12.01M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Please correct the following errors:</span>
                </div>
                <ul class="list-disc list-inside text-sm text-red-600 mt-2">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for form_instance in formset %}
                        {% for field, errors in form_instance.errors.items %}
                            {% for error in errors %}
                                <li>Component {{ forloop.parentloop.counter0 }} - {{ field }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- BOM Information -->
            <div class="p-6 border border-[hsl(var(--border))] rounded-lg bg-[hsl(var(--card))] shadow-sm">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-[hsl(var(--primary))]" viewBox="0 0 24 24" fill="none">
                        <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    BOM Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for field in form %}
                    <div class="relative">
                        {% if field.field.widget.input_type == 'select' %}
                        <select name="{{ field.name }}" id="{{ field.id_for_label }}"
                            class="w-full px-3 py-2 text-sm border {% if field.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-[hsl(var(--background))]{% endif %} text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--primary))]">
                            {% for value, label in field.field.choices %}
                            <option value="{{ value }}" {% if field.value == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        {% elif field.name in 'total_component_value,additional_cost,total_after_discount' %}
                        <input type="number" name="{{ field.name }}" value="{{ field.value|default:'0.00' }}" readonly
                            class="w-full px-3 py-2 text-sm border {% if field.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md bg-[hsl(var(--muted))] text-[hsl(var(--muted-foreground))] cursor-not-allowed">
                        {% else %}
                        <input type="{{ field.field.widget.input_type|default:'text' }}" name="{{ field.name }}" value="{{ field.value|default:'' }}"
                            class="w-full px-3 py-2 text-sm border {% if field.errors %}border-red-500{% else %}border-[hsl(var(--border))]{% endif %} rounded-md {% if is_detail_view %}bg-[hsl(var(--muted))] cursor-not-allowed{% else %}bg-[hsl(var(--background))]{% endif %} text-[hsl(var(--foreground))] focus:outline-none focus:ring-1 focus:ring-[hsl(var(--primary))]"
                            {% if is_detail_view %}readonly{% endif %} {% if field.field.required %}required{% endif %}>
                        {% endif %}
                        <label for="{{ field.id_for_label }}"
                            class="absolute left-3 -top-2.5 px-1 text-sm bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] transition-all">
                            {{ field.label }}{% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {% if field.errors %}
                        <div class="text-red-500 text-xs mt-1">
                            {% for error in field.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Component Information -->
            <div class="p-6 border border-[hsl(var(--border))] rounded-lg bg-[hsl(var(--card))] shadow-sm">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-[hsl(var(--primary))]" viewBox="0 0 24 24" fill="none">
                        <path d="M16 3H8C6.89543 3 6 3.89543 6 5V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V5C18 3.89543 17.1046 3 16 3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 18H12.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Component Information
                </h3>

                {{ formset.management_form }}

                <!-- Mobile View -->
                <div class="md:hidden space-y-4" id="mobileFormsetContainer">
                    {% for form in formset %}
                    <div class="mobile-formset-row p-4 border border-[hsl(var(--border))] rounded-lg relative" data-index="{{ forloop.counter0 }}">
                        <button type="button" class="mobile-context-btn absolute top-2 right-2 w-8 h-8 rounded-full bg-[hsl(var(--muted))] flex items-center justify-center">
                            <svg class="w-5 h-5 text-[hsl(var(--muted-foreground))]" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V5.01M12 12V12.01M12 19V19.01M12 6C11.4477 6 11 5.55228 11 5C11 4.44772 11.4477 4 12 4C12.5523 4 13 4.44772 13 5C13 5.55228 12.5523 6 12 6ZM12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 12.4477 13 12C13 12.5523 12.5523 13 12 13ZM12 20C11.4477 20 11 19.5523 11 19C11 18.4477 11.4477 18 12 18C12.5523 18 13 18.4477 13 19C13 19.5523 12.5523 20 12 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="space-y-3">
                            {% for field in form %}
                            {% if field.name != 'DELETE' %}
                            <div class="relative">
                                <input type="{{ field.field.widget.input_type|default:'text' }}" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}"
                                    class="{{ field.field.widget.attrs.class }} {% if field.errors %}border-red-500{% endif %}"
                                    id="{{ field.id_for_label }}"
                                    {% if is_detail_view %}readonly{% endif %} {% if field.field.required %}required{% endif %}>
                                <label for="{{ field.id_for_label }}"
                                    class="absolute left-3 -top-2.5 px-1 text-sm bg-[hsl(var(--background))] text-[hsl(var(--muted-foreground))] transition-all">
                                    {{ field.label }}{% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if field.errors %}
                                <div class="text-red-500 text-xs mt-1">
                                    {% for error in field.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}" class="delete-checkbox hidden">
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="delete-row mobile-delete-row inline-flex items-center px-3 py-2 text-sm font-medium text-[hsl(var(--destructive))] hover:bg-[hsl(var(--destructive))/10] rounded-md">
                                <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                                    <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Mobile Context Menu -->
                <div id="mobileContextMenu" class="hidden fixed z-50 w-48 bg-[hsl(var(--background))] rounded-md shadow-lg border border-[hsl(var(--border))]">
                    <div class="py-1">
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors" id="mobileAddRowAboveBtn">Add Row Above</button>
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors" id="mobileAddRowBelowBtn">Add Row Below</button>
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--destructive))] hover:bg-[hsl(var(--accent))] transition-colors" id="mobileDeleteRowBtn">Delete Row</button>
                    </div>
                </div>

                <!-- Desktop View -->
                <div class="hidden md:block">
                    <div class="overflow-x-auto overflow-y-auto max-h-[400px] rounded-lg border border-[hsl(var(--border))] shadow-inner">
                        <table class="w-full min-w-[800px]">
                            <thead class="sticky top-0 bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))]">
                                <tr>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Item Code</th>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Item Name</th>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Quantity</th>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Unit</th>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Unit Price</th>
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Total</th>
                                    {% if not is_detail_view %}
                                    <th class="py-3 px-4 text-sm font-semibold uppercase tracking-wider text-center">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="formsetBody" class="divide-y divide-[hsl(var(--border))]">
                                {% for form in formset %}
                                <tr class="formset-row hover:bg-[hsl(var(--accent))] transition-colors {% if form.errors %}bg-red-50{% endif %}" data-index="{{ forloop.counter0 }}">
                                    {% for field in form %}
                                    {% if field.name != 'DELETE' %}
                                    <td class="py-2 px-4">
                                        <input type="{{ field.field.widget.input_type|default:'text' }}" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}"
                                            class="{{ field.field.widget.attrs.class }} {% if field.errors %}border-red-500{% endif %}"
                                            id="{{ field.id_for_label }}"
                                            {% if is_detail_view %}readonly{% endif %} {% if field.field.required %}required{% endif %}>
                                        {% if field.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in field.errors %}
                                            <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% else %}
                                    <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}" class="delete-checkbox hidden">
                                    {% endif %}
                                    {% endfor %}
                                    {% if not is_detail_view %}
                                    <td class="py-2 px-4">
                                        <button type="button" class="delete-row desktop-delete-row inline-flex items-center justify-center rounded-full w-8 h-8 bg-[hsl(var(--destructive))] text-[hsl(var(--destructive-foreground))] hover:bg-[hsl(var(--destructive))/90]">
                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                                                <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% if form.non_field_errors %}
                                <tr class="bg-red-50">
                                    <td colspan="{% if is_detail_view %}6{% else %}7{% endif %}" class="py-2 px-4 text-red-600 text-sm">
                                        {% for error in form.non_field_errors %}
                                        <p>{{ error }}</p>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Desktop Context Menu -->
                    <div id="contextMenu" class="hidden fixed z-50 w-48 bg-[hsl(var(--background))] rounded-md shadow-lg border border-[hsl(var(--border))]">
                        <div class="py-1">
                            <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors" id="addRowAboveBtn">Add Row Above</button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--foreground))] hover:bg-[hsl(var(--accent))] transition-colors" id="addRowBelowBtn">Add Row Below</button>
                            <button type="button" class="w-full text-left px-4 py-2 text-sm text-[hsl(var(--destructive))] hover:bg-[hsl(var(--accent))] transition-colors" id="deleteRowBtn">Delete Row</button>
                        </div>
                    </div>
                </div>

                <!-- Add Row Button -->
                {% if not is_detail_view %}
                <button type="button" id="addRowBtn" class="mt-4 w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-medium bg-gradient-to-r from-[hsl(var(--primary))] to-[hsl(var(--accent))] text-[hsl(var(--primary-foreground))] hover:opacity-90 h-10 px-4 py-2 shadow-md">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Add Component
                </button>
                {% endif %}
            </div>

            <!-- Form Footer -->
            <div class="border-t pt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-[hsl(var(--muted-foreground))]">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" viewBox="0 0 24 24" fill="none">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Your data is secure and encrypted
                    </span>
                </div>
                <div class="flex gap-3 w-full sm:w-auto">
                    {% if cancel_url %}
                    <a href="{{ cancel_url }}" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-sm font-medium bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))] hover:opacity-90 h-10 px-4 py-2 shadow-md">
                        {% if is_detail_view %}Back{% else %}Cancel{% endif %}
                    </a>
                    {% endif %}
                    {% if not is_detail_view %}
                    <button type="reset" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-sm font-medium bg-[hsl(var(--secondary))] text-[hsl(var(--secondary-foreground))] hover:opacity-90 h-10 px-4 py-2 shadow-md">
                        Reset
                    </button>
                    <button type="submit" id="submitBtn" class="flex-1 sm:flex-initial inline-flex items-center justify-center rounded-lg text-sm font-medium bg-gradient-to-r from-[hsl(var(--primary))] to-[hsl(var(--accent))] text-[hsl(var(--primary-foreground))] hover:opacity-90 h-10 px-4 py-2 shadow-md">
                        <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12L10 17L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {{ submit_text|default:"Submit" }}
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mobileContainer = document.getElementById('mobileFormsetContainer');
        const desktopBody = document.getElementById('formsetBody');
        const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
        const addRowBtn = document.getElementById('addRowBtn');
        const contextMenu = document.getElementById('contextMenu');
        const mobileContextMenu = document.getElementById('mobileContextMenu');

        let currentRow = null;
        let currentMobileRow = null;

        function addNewRow(position = null, referenceIndex = null) {
            let template = desktopBody?.querySelector('.formset-row') || mobileContainer?.querySelector('.mobile-formset-row');
            if (!template) {
                console.error("No template row found");
                return;
            }

            const currentFormCount = parseInt(totalForms.value);
            const newIndex = currentFormCount;

            // Clone and update template
            const newRow = template.cloneNode(true);
            newRow.querySelectorAll('input, select').forEach(input => {
                if (input.name) input.name = input.name.replace(/-\d+-/, `-${newIndex}-`);
                if (input.id) input.id = input.id.replace(/-\d+-/, `-${newIndex}-`);
                if (input.type !== 'hidden' && !input.classList.contains('delete-checkbox')) {
                    input.value = input.type === 'number' ? (input.name.includes('quantity') ? '1' : '0') : input.name.includes('unit') ? 'Pcs' : '';
                }
            });

            const deleteCheckbox = newRow.querySelector('.delete-checkbox');
            if (deleteCheckbox) deleteCheckbox.checked = false;
            newRow.dataset.index = newIndex;

            // Insert row
            if (desktopBody) {
                if (position === 'above' && referenceIndex !== null) {
                    const referenceRow = desktopBody.querySelector(`.formset-row[data-index="${referenceIndex}"]`);
                    desktopBody.insertBefore(newRow, referenceRow || null);
                } else if (position === 'below' && referenceIndex !== null) {
                    const referenceRow = desktopBody.querySelector(`.formset-row[data-index="${referenceIndex}"]`);
                    desktopBody.insertBefore(newRow, referenceRow?.nextSibling || null);
                } else {
                    desktopBody.appendChild(newRow);
                }
            }

            if (mobileContainer) {
                const mobileTemplate = mobileContainer.querySelector('.mobile-formset-row').cloneNode(true);
                mobileTemplate.querySelectorAll('input, select').forEach(input => {
                    if (input.name) input.name = input.name.replace(/-\d+-/, `-${newIndex}-`);
                    if (input.id) input.id = input.id.replace(/-\d+-/, `-${newIndex}-`);
                    if (input.type !== 'hidden' && !input.classList.contains('delete-checkbox')) {
                        input.value = input.type === 'number' ? (input.name.includes('quantity') ? '1' : '0') : input.name.includes('unit') ? 'Pcs' : '';
                    }
                });
                const mobileDeleteCheckbox = mobileTemplate.querySelector('.delete-checkbox');
                if (mobileDeleteCheckbox) mobileDeleteCheckbox.checked = false;
                mobileTemplate.dataset.index = newIndex;

                if (position === 'above' && referenceIndex !== null) {
                    const referenceRow = mobileContainer.querySelector(`.mobile-formset-row[data-index="${referenceIndex}"]`);
                    mobileContainer.insertBefore(mobileTemplate, referenceRow || null);
                } else if (position === 'below' && referenceIndex !== null) {
                    const referenceRow = mobileContainer.querySelector(`.mobile-formset-row[data-index="${referenceIndex}"]`);
                    mobileContainer.insertBefore(mobileTemplate, referenceRow?.nextSibling || null);
                } else {
                    mobileContainer.appendChild(mobileTemplate);
                }
            }

            totalForms.value = currentFormCount + 1;
            setupRowEventHandlers();
            updateFinancials();
        }

        function setupRowEventHandlers() {
            document.querySelectorAll('.delete-row').forEach(button => {
                button.removeEventListener('click', handleDeleteRow); // Prevent duplicate listeners
                button.addEventListener('click', handleDeleteRow);
            });

            document.querySelectorAll('.quantity-input, .unit-price-input').forEach(input => {
                input.removeEventListener('input', calculateRowTotal);
                input.addEventListener('input', calculateRowTotal);
            });

            if (desktopBody) {
                desktopBody.removeEventListener('contextmenu', handleContextMenu);
                desktopBody.addEventListener('contextmenu', handleContextMenu);
            }

            document.querySelectorAll('.mobile-context-btn').forEach(button => {
                button.removeEventListener('click', handleMobileContextMenu);
                button.addEventListener('click', handleMobileContextMenu);
            });
        }

        function handleDeleteRow() {
            const row = this.closest('.formset-row, .mobile-formset-row');
            const index = row.dataset.index;
            const deleteCheckbox = row.querySelector('.delete-checkbox');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
                if (row.classList.contains('formset-row')) {
                    const mobileRow = mobileContainer?.querySelector(`.mobile-formset-row[data-index="${index}"]`);
                    if (mobileRow) mobileRow.style.display = 'none';
                } else {
                    const desktopRow = desktopBody?.querySelector(`.formset-row[data-index="${index}"]`);
                    if (desktopRow) desktopRow.style.display = 'none';
                }
                updateFinancials();
            }
        }

        function handleContextMenu(e) {
            e.preventDefault();
            const row = e.target.closest('.formset-row');
            if (row) {
                currentRow = row;
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.style.display = 'block';
            }
        }

        function handleMobileContextMenu(e) {
            e.preventDefault();
            const mobileRow = this.closest('.mobile-formset-row');
            if (mobileRow) {
                currentMobileRow = mobileRow;
                const rect = this.getBoundingClientRect();
                mobileContextMenu.style.left = `${rect.left}px`;
                mobileContextMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
                mobileContextMenu.style.display = 'block';
            }
        }

        function calculateRowTotal(e) {
            const row = e.target.closest('.formset-row, .mobile-formset-row');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price-input').value) || 0;
            const totalInput = row.querySelector('.total-input');
            if (totalInput) {
                totalInput.value = (quantity * unitPrice).toFixed(6);
                updateFinancials();
            }
        }

        function updateFinancials() {
            let totalComponentValue = 0;
            document.querySelectorAll('.formset-row:not([style*="display: none"]), .mobile-formset-row:not([style*="display: none"])').forEach(row => {
                const total = parseFloat(row.querySelector('.total-input').value) || 0;
                totalComponentValue += total;
            });

            const totalComponentValueInput = document.querySelector('[name="total_component_value"]');
            const otherCostPercentageInput = document.querySelector('[name="other_cost_percentage"]');
            const additionalCostInput = document.querySelector('[name="additional_cost"]');
            const totalAfterDiscountInput = document.querySelector('[name="total_after_discount"]');

            if (totalComponentValueInput) totalComponentValueInput.value = totalComponentValue.toFixed(2);
            const otherCostPercentage = parseFloat(otherCostPercentageInput?.value) || 0;
            const additionalCost = totalComponentValue * (otherCostPercentage / 100);
            if (additionalCostInput) additionalCostInput.value = additionalCost.toFixed(2);
            if (totalAfterDiscountInput) totalAfterDiscountInput.value = (totalComponentValue + additionalCost).toFixed(2);
        }

        // Context menu actions
        document.getElementById('addRowAboveBtn')?.addEventListener('click', () => {
            if (currentRow) {
                addNewRow('above', currentRow.dataset.index);
                contextMenu.style.display = 'none';
            }
        });

        document.getElementById('addRowBelowBtn')?.addEventListener('click', () => {
            if (currentRow) {
                addNewRow('below', currentRow.dataset.index);
                contextMenu.style.display = 'none';
            }
        });

        document.getElementById('deleteRowBtn')?.addEventListener('click', () => {
            if (currentRow) {
                currentRow.querySelector('.delete-row').click();
                contextMenu.style.display = 'none';
            }
        });

        document.getElementById('mobileAddRowAboveBtn')?.addEventListener('click', () => {
            if (currentMobileRow) {
                addNewRow('above', currentMobileRow.dataset.index);
                mobileContextMenu.style.display = 'none';
            }
        });

        document.getElementById('mobileAddRowBelowBtn')?.addEventListener('click', () => {
            if (currentMobileRow) {
                addNewRow('below', currentMobileRow.dataset.index);
                mobileContextMenu.style.display = 'none';
            }
        });

        document.getElementById('mobileDeleteRowBtn')?.addEventListener('click', () => {
            if (currentMobileRow) {
                currentMobileRow.querySelector('.delete-row').click();
                mobileContextMenu.style.display = 'none';
            }
        });

        addRowBtn?.addEventListener('click', () => addNewRow());

        document.addEventListener('click', e => {
            if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none';
            if (!mobileContextMenu.contains(e.target)) mobileContextMenu.style.display = 'none';
        });

        document.addEventListener('scroll', () => {
            contextMenu.style.display = 'none';
            mobileContextMenu.style.display = 'none';
        });

        setupRowEventHandlers();
        updateFinancials();
    });
</script>
<script src="{% static 'js/collapse.js' %}"></script>
<script src="{% static 'js/select-search.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        makeSelectSearchable('product');
        makeSelectSearchable('uom');
    });
</script>
{% endblock %}